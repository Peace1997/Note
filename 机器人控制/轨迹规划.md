# 轨迹规划

仿真实验里，我们可以任意给定两个点：初始位置和终止位置，通过空间**直线插补**计算该直线的相关信息，也可以给定三个点：初始位置、引导位置、终止位置，通过空间**圆弧插补**计算该圆弧的相关信息，然后可以根据直线的位移和圆弧的角度，使用梯形速度曲线轨迹规划获取空间姿态/速度，通过空间姿态/利用**逆运动学**求解关节角度轨迹，最后根据关节角度轨迹，利用**雅可比矩阵**计算各个关节的速度和加速度。


## 一、  插补函数

已知曲线上的某些数据，按照某种算法计算已知点之间的中间点的方法，也称为“数据点的密化”。

### 1. 直线插补算法

已知空间直线的起点S位置坐标为$( x_1 , y_1 , z_1 )$，终点D位置坐标为$( x_2 , y_2 , z_2 )$和插补次数N：
$$
\left\{\begin{array}{l}
\Delta x=\left(x_{2}-x_{1}\right) /(N+1) \\
\Delta y=\left(y_{2}-y_{1}\right) /(N+1) \\
\Delta z=\left(z_{2}-z_{1}\right) /(N+1)
\end{array}\right.
$$
对于该直线上任一点i(1<= i <= N)有
$$
\left\{\begin{array}{l}
x_{i}=x_{1}+\Delta x \cdot i \\
y_{i}=y_{1}+\Delta y \cdot i \\
z_{i}=z_{1}+\Delta z \cdot i
\end{array}\right.
$$
基于抛物线过渡（梯形加减速）的空间直线插补的核心在于归一化参数λ的计算，同时加入速度规划的物理条件和约束。因此得到的直线插补算法需要初始化的参数有机械臂末端线速度$v_s$、加速度$a_a$、减速度$a_d$、需要计算得到的插值参数有总位移$S$和插值点数$N$。

对于空间直线插补而言，总位移计算公式如下：
$$
S_{e}=\sqrt{\left(x_{2}-x_{1}\right)^{2}+\left(y_{2}-y_{1}\right)^{2}+\left(z_{2}-z_{1}\right)^{2}}
$$

插值点数的计算公式如下所示：
$$
\mathrm{N}=P_{n} \frac{S_{e}}{V_{s}}
$$
其中$P_n$为插值参数，可以根据情况进行调整，如果总位移越大，线速度越小，则插值点数应该越多。原因在于，如果位移越大，在速度不变的情况下，一定要保证更多的插值点才能对规划曲线进行有效的拟合。同样的，如果位移不变，为了得到大的运动速度，则要降低插值点数，因为插值过程是一个等时间间隔的过程，插值点数越多，意味着所需时间越长。



### 2. 圆弧插补算法

#### 2.1 确定圆心和半径

 $P_1 、 P_2 、 P_3$ 为空间中任意不共线的三个点, 其中 $P_1(x_{1}, y_{1}, z_{1})$、 $P_2(x_{2}, y_{2}, z_{3})$、 $P_ 3(x_{3}, y_{3}, z_{3})$ 为三点在基座标系中的坐标。那么这三个点可以唯一确 定一个外接圆, 该园所在平面 $M_{1}$ 的方程如下:
$$
\left|\begin{array}{ccc}
x-x_{3} & y-y_{3} & z-z_{3} \\
x_{1}-x_{3} & y_{1}-y_{3} & z_{1}-z_{3} \\
x_{2}-x_{3} & y_{2}-y_{3} & z_{2}-z_{3}
\end{array}\right|=0 \quad(8)
$$

该外接圆方程的一般形式如下:
$$
A_{1} x+B_{1} y+C_{1} z+D_{1}=0
$$
其中,
$$
\begin{aligned}
&A_{1}=\left(y_{1}-y_{3}\right)\left(z_{2}-z_{3}\right)-\left(y_{2}-y_{3}\right)\left(z_{1}-z_{3}\right) \\
&B_{1}=\left(x_{2}-x_{3}\right)\left(z_{1}-z_{3}\right)-\left(x_{1}-x_{3}\right)\left(z_{2}-z_{3}\right) \\
&C_{1}=\left(x_{1}-x_{3}\right)\left(y_{2}-y_{3}\right)-\left(x_{2}-x_{3}\right)\left(y_{1}-y_{3}\right) \\
&D_{1}=-\left(A_{1} \cdot x_{3}+B_{1} \cdot y_{3}+C_{1} \cdot z_{3}\right)
\end{aligned}
$$
$P_1P_2$ 的垂直平分面 $\mathrm{M} 2$ 的方程如下:
$$
A_{2} x+B_{2} y+C_{2} z+D_{2}=0
$$
其中,
$$
\begin{aligned}
&A_{2}=x_{2}-x_{1} \\
&B_{2}=y_{2}-y_{1} \\
&C_{2}=z_{2}-z_{1} \\
&D_{2}=\left[\left(x_{2}^{2}-x_{1}^{2}\right)+\left(y_{2}^{2}-y_{1}^{2}\right)+\left(z_{2}^{2}-z_{1}^{2}\right)\right] / 2
\end{aligned}
$$
P2P3的垂直平分面 $M 3$ 的方程如下:
$$
A_{3} x+B_{3} y+C_{3} z+D_{3}=0 \quad(11)
$$
其中,
$$
\begin{aligned}
&A_{3}=x_{3}-x_{2} \\
&B_{3}=y_{3}-y_{2} \\
&C_{3}=z_{3}-z_{2} \\
&D_{3}=-\left[\left(x_{3}^{2}-x_{2}^{2}\right)+\left(y_{3}^{2}-y_{2}^{2}\right)+\left(z_{3}^{2}-z_{2}^{2}\right)\right] / 2
\end{aligned}
$$
综上, 联立M1、M2、M3三个平面的方程, 可得到如下算式:
$$
\left|\begin{array}{lll}
A_{1} & B_{1} & C_{1} \\
A_{2} & B_{2} & C_{2} \\
A_{3} & B_{3} & C_{3}
\end{array}\right|\left|\begin{array}{c}
x \\
y \\
z
\end{array}\right|=\left|\begin{array}{l}
-D_{1} \\
-D_{2} \\
-D_{3}
\end{array}\right|
$$
公式 (12) 有且仅有唯一一组解, 可解得三点外接圆圆心 $P_0$ 的位置坐标为 $\left(x_{0}, y_{0}, z_{0}\right)$, 根据圆心坐 标可求得外接圆半径为
$$
r=\sqrt{\left(x_{1}-x_{0}\right)^{2}+\left(y_{1}-y_{0}\right)^{2}+\left(z_{1}-z_{0}\right)^{2}}
$$

#### 2.2 坐标变换

在以圆心 $P_0$ 为原点的基础上建立新的坐标系 $\{P_0-X_0 Y_0 Z_0\}$ 新坐标系中的 $Z_0$ 为平面 M1 的法矢量, 从 上文可得 $Z_0$ 轴的方向余弦为：
$$
a_{x}=A_{1} / L, \quad a_{y}=B_{1} / L, \quad a_{z}=C_{1} / L \text { (14) }
$$
其中, $L=\left(A_{1}^{2}+B_{1}^{2}+C_{1}^{2}\right)^{1 / 2}$

此处, 规定新坐标系 $\{P_0-X_0 Y_0 Z_0\}$ 的$X_0$为 $P_0 P_1$ 的矢量方向，故可得$X_0$轴的方向余弦如下:
$$
n_{i}=\frac{\left(i_{1}-i_{0}\right)}{\sqrt{\left(x_{1}-x_{0}\right)^{2}+\left(y_{1}-y_{0}\right)^{2}+\left(z_{1}-z_{0}\right)^{2}}}
$$
其中, $i=x,y,z$ 。

确定$Z_0$和$X_0$的方向后，根据右手定则即可确定$Y_0$的方向，如下:
$$
\boldsymbol{Y}_{1}=\boldsymbol{X}_{1} \times \boldsymbol{Z}_{1}
$$
在得到新坐标系三个轴的方向余弦后, 根据旋转矩阵的定义, 可得到新坐标系 $\{P_0-X_0 Y_0 Z_0\}$ 相对于基座标系 $\{O-X Y Z\}$ 的齐次变换矩阵
$$
T=\left[\begin{array}{cccc}
X_{1} & Y_{1} & Z_{1} & P_{1} \\
0 & 0 & 0 & 1
\end{array}\right]
$$
因此, 可通过齐次变换矩阵 T 将基座标系内的空间圆弧变换到新坐标系内的平面圆弧, 简化求解过程。


#### 2.3 转换为平面圆弧问题

根据齐次变换矩阵, $P_1、P_2、P_3$在新坐标系下的坐标$Q_1、Q_2、Q_3$可通过下面公式计算得到:
$$
\left|Q_{i}, 1\right|^{\mathrm{T}}=T^{-1}\left|P_{i}, 1\right|^{\mathrm{T}}(i=1,2,3)
$$
在平面内进行圆弧插补, 实际上就是对圆心角进行插补, 因此核心就是求出圆弧的圆心角, 同时还需要注意顺逆时针的问题。

####  2.4 圆心角和插值点数 N

由于 atan2 函数返回的是原点至点 $(x, y)$ 的方位角, 即与 $x$ 轴的夹角。也可以理解为复数 $x+y_i$ 的辐角。 返回值的单位为弧度。在数学坐标系中, 结果为正表示从 $X$ 轴逆时针旋转的角度, 结果为负表示从 $X$ 轴顺时针旋转的角度。此时为了判断圆弧是顺时针还是逆时针, 需要将角度值转换成 $0 \sim 2 \pi$ 的范围。

假设 $\angle P_{1} P_{0} P_{2}$ 为 $P_{0} P_{2}$ 与 $P_{0} X_{0}$ 正向的夹角, 有
$$
\angle P_{1} P_{0} P_{2}=\operatorname{atan} 2\left(P_{2 y}, P_{2 x}\right)+n * 2 \pi
$$
其中 $P_{2 y} 、 P_{2 x}$ 是 $\mathrm{P} 2$ 在新坐标系下的坐标值。此时存在如下两种情况:

1. 当 $\operatorname{atan} 2\left(P_{2 y}, P_{2 x}\right)<0$ 时, $n=1$;
2. 否则, $n=0$ 。
   同理, 假设 $\angle P_{1} P_{0} P_{3}$ 为 $P_{0} P_{3}$ 与 $P_{0} X_{0}$ 正向的夹角, 有

$$
\angle P_{1} P_{0} P_{3}=\operatorname{atan} 2\left(P_{3 y}, P_{3 x}\right)+n * 2 \pi
$$

其中 $P_{3 y} 、 P_{3 x}$ 是 $\mathrm{P} 2$ 在新坐标系下的坐标值。此时存在如下两种情况:

1. 当 $\operatorname{atan} 2\left(P_{3 y}, P_{3 x}\right)<0$ 时, $n=1$;
2. 否则, $n=0$ 。
   通过比较 $\angle P_{1} P_{0} P_{2}$ 和 $\angle P_{1} P_{0} P_{3}$ 的大小可以确定圆弧的方向, 同时可以求出圆弧圆心角 $\Omega$ :
3. 当 $\angle P_{1} P_{0} P_{2}<\angle P_{1} P_{0} P_{3}$ 时, 圆弧为逆时针, 圆心角 $\Omega=\angle P_{1} P_{0} P_{3}$;
4. 当 $\angle P_{1} P_{0} P_{2} \geq \angle P_{1} P_{0} P_{3}$ 时, $\Omega=2 \pi-\angle P_{1} P_{0} P_{3}$;

对应基于抛物线过渡（梯形加减速）的空间圆弧插补而言, 需要初始化的运动参数有机械臂末端角速算$\omega_{s}$和加速度$a$，根据上面求得的圆心角$\Omega$，插值点计算公式如下:
$$
\mathrm{N}=P_{n} \frac{\Omega}{\omega_{s}}
$$




## 二、机器人轨迹：

**点到点轨迹 (P2P)**

- 五次多项式差值轨迹
- 二次多项式差值轨迹
- 多项式轨迹
- 梯形速度曲线轨逑
- 双S形速度曲线轨迹
- 多个自由度轨迹的时间同步

**在线轨迹规划**

- 多项式在线轨迹规划
- 梯形在线轨迹规划
- 双S形在线轨迹规划
- 非线性实时轨迹滤波

**多点轨迹 (Multi-point)**

- 三次样条曲线 (cubic spline)
- 贝赛尔曲线 (Bezier Curve)
- B样条曲线 (BSpline)

**时间最优轨迹**

- 三次样条时间最优轨迹
- 任意路径下的时间最优轨迹
- 时间最优停止轨迹
  - 不约束路径
  - 有路径约束

仿真实验里，我们可以任意给定两个点：初始位置和终止位置，通过空间直线插补计算该直线的相关信息，也可以给定三个点：初始位置、引导位置、终止位置，通过空间圆弧插补计算该圆弧的相关信息，然后可以根据直线的位移和圆弧的角度，使用梯形速度曲线轨迹规划获取空间位置，通过空间位置利用逆运动学求解关节角度轨迹，最后根据关节角度轨迹，计算各个关节的速度和加速度。

###  梯形速度轨迹

#### 简介
梯形速度轨迹分为三段，分别是加速段、匀速段、减速段



#### 约束条件

- $t_{0}$ : 起始时间戳, 一般为 0
- $q_{0}$ : 起始位置（角度）
- $v_{0}$ ：起始速度
- $t_{1}$ : 结束时间戳
- $q_{1}$ : 结束位置
- $v_{1}$ : 结束速度
- $v_{\max }$ : 最大速度
- $a_{\max }$ : 最大加速度

同时每一段轨迹都需要知道时间长度和加速度

- $T_{a}$ :加速段的时间长度
- $T_{v}$ : 匀速段的时间长度
- $T_{d}$ : 减速段的时间长度
- $v_{v}$ : 匀速段的速度
- $a_{a}$ : 匀加速段的加速度
- $a_{d}$ : 匀减速段的加速度



#### T型曲线说明

- 匀加速段： 0$\leq$ t $\leq$ $T_a$:

  以恒定的加速度$a_{max}$加速，使速度从$v_0$增加到$v_{max}$

- 匀速段：$T_a \leq t \leq  T_a + T_v$:

  以恒定的速度$v_{max}$进行匀速运动

- 匀减速段 $T_a + T_v \leq t \leq T_a + T_v + T_d$：

  以恒定的加速度$a_{max}$减速，使速度从$v_{max}$减少到$v_1$

> 注：如果位移比较短，可能是两段或一段。如果限定了起始和结束速度，在较小的位移小，得需要增加加速度才可能出现加速度梯形轨迹



####  T型速度曲线算法步骤

整体运行时间：$T = t_1 - t_0 = T_a + T_v + T_d$

加速末段速度计算： $v_v = v_0 + a_aT_a \rightarrow a_a = \frac{v_v-v_0}{T_a}$

减速末端速度变化： $v_1 = v_v + a_dT_d \rightarrow a_a = \frac{v_v-v_0}{T_a} = -a_a$

加速末端角度计算：$q_{v0} = q_0 + \frac{v_0+v_v}{2}T_a$

减速末端角度计算：$q_{d0} = q1- \frac{v_v+v_1}{2}T_d$

- 位置（关节角度）计算
  $$
  \begin{aligned}
  &q(t)=\left\{\begin{array}{lc}
  q_{0}+v_{0} \hat{t}+\frac{v_{v}-v_{0}}{2 T_{a}} \hat{t}^{2} & \hat{t} \in\left[0, T_{a}\right] \\
  q_{v 0}+v_{v}\left(\hat{t}-T_{a}\right) & \hat{t} \in\left[T_{a}, T-T_{d}\right] \\
  q_{d 0}+v_{v}\left(\hat{t}-T_{a}-T_{c}\right)+\frac{1}{2} a_{d}\left(\hat{t}-T_{a}-T_{c}\right)^{2} & \hat{t} \in\left[T-T_{d}, T\right]
  \end{array}\right.\\
  &=\left\{\begin{array}{lc}
  q_{0}+v_{0} \hat{t}+\frac{v_{v}-v_{0}}{2 T_{a}} \hat{t}^{2} & \hat{t} \in\left[0, T_{a}\right] \\
  q_{0}+\frac{v_{0}-v_{u}}{2} T_{a}+v_{v} \hat{t} & \hat{t} \in\left[T_{a}, T-T_{d}\right] \\
  q_{1}-v_{1}(T-\hat{t})-\frac{v_{v}-v_{1}}{2 T_{d}}(T-\hat{t})^{2} & \hat{t} \in\left[T-T_{d}, T\right]
  \end{array}\right.\\
  &=\left\{\begin{array}{lc}
  q_{0}+v_{0} \hat{t}+\frac{v_{v}-v_{0}}{2 T_{a}} \hat{t}^{2} & \hat{t} \in\left[0, T_{a}\right] \\
  q_{0}+\frac{v_{0}-v_{v}}{2} T_{a}+v_{v} \hat{t} & \hat{t} \in\left[T_{a}, T-T_{d}\right] \\
  q_{1}-v_{1} T-\frac{v_{v}-v_{1}}{2 T_{d}} T^{2}+\left(v_{1}+\frac{v_{v}-v_{y}}{T_{d}} T\right) \hat{t}-\frac{v_{v}-v_{1}}{2 T_{d}} \hat{t}^{2} & \hat{t} \in\left[T-T_{d}, T\right]
  \end{array}\right.
  \end{aligned}
  $$

- 三段速度计算
  $$
  \begin{aligned}
  \dot{q}(t) &=\left\{\begin{array}{lc}
  v_{0}+a_{a} \hat{t} & \hat{t} \in\left[0, T_{a}\right] \\
  v_{v} & \hat{t} \in\left[T_{a}, T_{a}+T_{v}\right] \\
  v_{v}+a_{d}\left(\hat{t}-T_{a}-T_{c}\right) & \hat{t} \in\left[T_{a}+T_{v}, T_{a}+T_{v}+T_{d}\right]
  \end{array}\right.\\
  &=\left\{\begin{array}{lc}
  v_{0}+\frac{v_{v}-v_{0}}{T_{a}} \hat{t} & \hat{t} \in\left[0, T_{a}\right] \\
  v_{v} & \hat{t} \in\left[T_{a}, T-T_{d}\right] \\
  v_{1}+\frac{v_{v}-v_{1}}{T_{d}}(T-\hat{t}) & \hat{t} \in\left[T-T_{d}, T\right]
  \end{array}\right.
  \end{aligned}
  $$

- 三段加速度计算
  $$
  \begin{aligned}
  \ddot{q}(t) &=\left\{\begin{array}{lc}
  a_{a} & \hat{t} \in\left[0, T_{a}\right] \\
  0 & \hat{t} \in\left[T_{a}, T_{a}+T_{v}\right] \\
  a_{d} & \hat{t} \in\left[T_{a}+T_{v}, T_{a}+T_{v}+T_{d}\right]
  \end{array}\right.\\
  &=\left\{\begin{array}{lc}
  \frac{v_{v}-v_{0}}{T_{a}} & \hat{t} \in\left[0, T_{a}\right] \\
  0 & \hat{t} \in\left[T_{a}, T-T_{d}\right] \\
  \frac{v_{1}-v_{v}}{T_{d}} & \hat{t} \in\left[T-T_{d}, T\right]
  \end{array}\right.
  \end{aligned}
  $$

- 初始条件
  - 给出最大速度$v_{max}$和最大加速度$a_{max} \rightarrow$ 整体时长$T = t_1 -t_0$，称为**确定时间轨迹**
  - 给出最大速度$v_{max}$和最大加速度$a_{max}$，在此约束下时间最短的轨迹（不给定整体时长），称为**时间最优轨迹**



#### 确定时间的加速度梯形轨迹

给定轨迹

步骤

1. 计算机械臂所能到达的最大速度（匀加速段）
  $$
  \begin{aligned}
  &\mathrm{q}_{1}-q_{0} \geq \frac{2 v_{\text {temp }}{ }^{2}-\left(v_{1}^{2}+v_{0}^{2}\right)}{2 a_{\max }} \\
  &\mathrm{v}_{\text {temp }}=\sqrt{\frac{\left(v_{1}^{2}+v_{0}^{2}\right)-2 a_{\max }\left(\mathrm{q}_{1}-q_{0}\right)}{2}}
  \end{aligned}
  $$

  > $q_1 - q_0 = \frac{1}{2}a_{max}(T_1 - T_0)^2$    $T_1 =\frac{v_1}{a_{max}} 、 T_0 =\frac{v_0}{a_{max}}$   ; $|v_1^2 - v_0^2| \leq 2a_{max}(q_1 - q_0)$ ; 

2. 分类讨论机械臂所能达到的最大速度和设定最大速度的大小
  - 若$v_{temp} < v_{max}$：$v_{lim} = v_{temp}$
  - 否则：$v_{lim} = v_{max}$

3. 分别计算匀加速、匀速、匀减速的时间和位移

  - $t \in [0,T_a)$:
    $$
\begin{align*}
    T_a = \frac {v_{lim}-v_0}{a_{max}} \\
    S_a = v_0T_a + \frac{1}{2}a_{max}T_a^2 \\
    
    q=q_{0}+v_{0} t+\frac{a_{\max } t^{2}}{2} \\
    \mathrm{dq}=v_{0}+a_{\max } t \\
    \mathrm{ddq}=a_{\max } \\
\end{align*}
    $$
    
  - $t\in[T_a ,Ta+T_v]$:
    $$
    \begin{gathered}
    \mathrm{T}_{v}=\frac{q_{1}-q_{0}-\frac{v_{1}^{2}+v_{0}^{2}-2 v_{l i m}^{2}}{2 a_{\max }}}{v_{l i m}} \\
    \mathrm{~S}_{v}=v_{l i m} T_{v}\\
    \mathrm{q}=q_{0}+S_{a}+v_{l i m}\left(t-T_{a}\right) \\
    \mathrm{dq}=v_{l i m} \\
    \mathrm{ddq}=0
    \end{gathered}
    $$
  
  - $t \in [\mathrm{T}_{a}+\mathrm{T}_{v},\mathrm{~T}_{a}+\mathrm{T}_{v}+\mathrm{T}_{\mathrm{d}})$:
    $$
    \begin{gathered}
    \\
    \mathrm{T}_{\mathrm{d}}=\frac{v_{l i m}-v_{1}}{a_{\max }} \\
    \mathrm{S}_{v}=v_{l i m} T_{d}-\frac{1}{2} a_{\max } T_{d}^{2} \\
    
    \mathrm{q}=q_{0}+S_{a}+S_{v}-\frac{1}{2} a_{\max }\left(t-T_{a}-T_{v}\right)^{2} \\
    \mathrm{dq}=v_{l i m}-\mathrm{a}_{\max }\left(t-T_{a}-T_{v}\right) \\
    \mathrm{ddq}=-\mathrm{a}_{\max }
    
    
    \end{gathered}
    $$
    

#### 归一化后位移公式

设机械臂在匀速运动时的线速度为 $v_{s}$, 抛物线段的加减速度均为 $a$, 可以计算出加速阶段和减速阶段的时间和位移为
$$
T_{1}=\frac{V_{s}}{a}
$$
$$
S_{1}=\frac{1}{2} a T_{1}^{2}
$$

设机械臂末端运动的总位移为 $S_{e}$ ，总时间为:
$$
T_{e}=2 T_{1}+\frac{s_{e}-2 S_{1}}{V_{s}}
$$
将位移、速度和加速度进行归一化处理得到上述计算量的归一化参数：
$$
\begin{align*}
& S_{1 \lambda}=\frac{s_{1}}{s_{e}} \\\\
& T_{1 \lambda}=\frac{T_{1}}{T_{e}} \\\\
&T_{2 \lambda}=1-T_{1 \lambda} \quad \\\\
&a_{\lambda}=\frac{2 s_{1 \lambda}}{T_{1 \lambda}^{2}}
\end{align*}

$$
结合梯形加减速的位移公式, 可以推导出归一化因子 $\lambda$ 的计算公式如下:
$$
\lambda=\left\{\begin{array}{cc}
\frac{1}{2} a_{\lambda} t^{2} & \left(0 \leq t \leq T_{1 \lambda}\right) \\
\frac{1}{2} a_{\lambda} T_{1 \lambda}^{2}+a_{\lambda} T_{1 \lambda}\left(t-T_{1 \lambda}\right) & \left(T_{1 \lambda}<t \leq T_{2 \lambda}\right) \\
\frac{1}{2} a_{\lambda} T_{1 \lambda}^{2}+a_{\lambda} T_{1 \lambda}\left(T_{2 \lambda}-T_{1 \lambda}\right)+\frac{1}{2} a_{\lambda}\left(t-T_{2 \lambda}\right)^{2} & \left(T_{2 \lambda}<t \leq 1\right)
\end{array}\right.
$$



## 三、已知末端速度计算关节速度

**问题描述**： 当前是在**平面上**画直线和圆弧，前面经过直线、圆弧插补以及T型轨迹曲线，可以计算得到末端角度的变化，通过逆运动学得到关节角度后，直接对关节角度求导获得关节速度和关节加速度方法可能会不太准确。

**解决方法**：通过**雅可比矩阵**实现关节空间和操作空间的转换。

**具体实现**：

1. 利用T型速度轨迹曲线，计算机得到 机械臂末端归一化后的位移（角度）
  $$
  \lambda=\left\{\begin{array}{cc}
  \frac{1}{2} a_{\lambda} t^{2} & \left(0 \leq t \leq T_{1 \lambda}\right) \\
  \frac{1}{2} a_{\lambda} T_{1 \lambda}^{2}+a_{\lambda} T_{1 \lambda}\left(t-T_{1 \lambda}\right) & \left(T_{1 \lambda}<t \leq T_{2 \lambda}\right) \\
  \frac{1}{2} a_{\lambda} T_{1 \lambda}^{2}+a_{\lambda} T_{1 \lambda}\left(T_{2 \lambda}-T_{1 \lambda}\right)+\frac{1}{2} a_{\lambda}\left(t-T_{2 \lambda}\right)^{2} & \left(T_{2 \lambda}<t \leq 1\right)
  \end{array}\right.
  $$

2. 根据归一化位移公式计算机械臂末端归一化速度和加速度：
$$
vel_\lambda =\left\{\begin{array}{cc}
a_{\lambda} t & \left(0 \leq t \leq T_{1 \lambda}\right) \\
a_{\lambda} T_{1 \lambda}+a_{\lambda}& \left(T_{1 \lambda}<t \leq T_{2 \lambda}\right) \\
a_{\lambda} T_{1 \lambda}- a_{\lambda}\left(t-T_{2 \lambda}\right) & \left(T_{2 \lambda}<t \leq 1\right)
\end{array}\right.
$$$$
vel_\lambda =\left\{\begin{array}{cc}
a_{\lambda}  & \left(0 \leq t \leq T_{1 \lambda}\right) \\
0 & \left(T_{1 \lambda}<t \leq T_{2 \lambda}\right) \\
-a_{\lambda} & \left(T_{2 \lambda}<t \leq 1\right)
\end{array}\right.
$$
3. 机械臂末端 速度、加速度归一化还原：
$$
\begin{align*}
  &acc = acc_\lambda * (\frac{a}{a_{\lambda}}) \\
  &vel  = vel_\lambda * (\frac{a}{a_{\lambda}}) * T_e
\end{align*}
$$

  > 其中$a$为原设定的加速度大小，$T_e$为总时长

4. 分速度、加速度计算：（**将速度和加速度转换为6维，方便雅可比矩阵的转换**）

- 直线规划：
	- 根据上一步计算机械臂末端的**线速度和线加速度**，将速度和加速度其分解到x、y轴：（六维空间表示）
$$
\begin{align*}
vel_1 = vel * cos(\theta) \\
vel_2 = vel * sin(\theta) \\ 
acc_1 = acc * cos(\theta) \\
acc_2 = acc * sin(\theta)
\end{align*}
$$

  - 圆弧规划：
	- 根据上一步计算机械臂末端的**角速度和角加速度**，首先根据线速度和角速度的转换公式，计算圆弧规划末端线速度、线加速度：
  $$
\begin{align*}
  vel_{line} = r * vel \\
  acc_{line} = r * acc
\end{align*}      
$$
	- 将速度分解到x、y、z轴上：
$$
\begin{align*}
&vel_1 = vel_{line} * cos(\theta)\\
&vel_2 = vel_{line} * sin(\theta)\\
&vel_6 = vel \\
&acc_1 = acc_{line} * cos(\theta)\\
&acc_2 = acc_{line} * sin(\theta)\\
&acc_6 = acc
\end{align*}
$$

5. 通过逆运动学计算得到关节角度$q$

6. 利用转换好的末端六维速度、加速度，通过**雅可比矩阵**实现操作空间和关节空间的转换：
  - **速度转换**
$$
    qd = J(q)^{-1} * vel
$$
  $J^{-1}$： 7x6 ;  $vel$：6 x 1  $\rightarrow$   qd： 7x1

  - **加速度转换：**
$$
    qdd = J^{-1} * acc + (J'(q,qd))^{-1} * vel
$$

$J^{-1}*acc$： 7x1 ;  $(J'(q,qd))^{-1}$：1x6  ;  vel ： 6x1   $\rightarrow$   qdd： 7x1

  















### 基本流程：

圆弧轨迹规划：

- 设定关节参数，通过`serialLink`对关节进行连接。

- 设定圆弧轨迹规划的起始点、引导点、终止点坐标，设定插补点数量(N)。通过**圆弧插补函数**，将三维空间插补转换为平面圆弧插补问题，然后通过转换公式和变换矩阵，将插补点从二维坐标转换为三维坐标（Nx3），在通过`transl`函数得到齐次坐标矩阵(Nx4x4)。

- 通过**逆运动学**将将齐次坐标矩阵转换为各关节角度值 $q$ (Nx7)，

- 根据各关节的角度值，通过**正运动学**得到末端的齐次变换矩阵 $T$ （Nx4x4）— 可视化

- 根据各关节角度值，反推各个关节的速度 $qd$ 和加速度 $qdd$  — 可视化

  



匀加速、匀减速优化：

问题描述：在指定时间内，先加速在匀速在减速完成轨迹规划任务

- 设定加速度大小、指定加速时间（即指定了最大速度）

- 如果小于加速时间，则进行加速，达到加速时间，开始匀速，到达减速时间时，开始进行减速

- 在第二步是，实时采集数据，获得角度轨迹阵列（N），然后通过转换公式和变换矩阵，得到每个插补点的三维坐标。

  



注: 

- 修改各个关节参数，设定加速度、时间（最大速度）
- 补充图（力矩、功率）
- 直角（可视化）、圆形