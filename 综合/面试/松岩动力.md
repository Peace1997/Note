
姜哲源，松延动力创始人。清华大学交叉信息学院博士。动纪元的联创，陈建宇（星动纪元_CEO_陈建宇）的核心团队成员

# 一、环境搭建  & 代码运行

由于本身电脑没有 N 卡，因此在智星云平台租用了一台 GeForce RTX 3090 云主机进行软件安装与环境搭建。
- IsaacGym_Preview_4 
- Python （3.7.12）
- Pytorch （1.12.0）
- Torchvision （0.13.0）
- Torchaudio（0.12.0）
- Cuda (12.2)
- NVIDIA GPU Driver  (535.146.02)

![[Pasted image 20240323091929.png]]

运行 legged_gym 库中 A1 的代码，训练 1500 个 iteration，A 1 机器人可以在多种地形环境中运动，并通过 cv2 将每帧图像转换为视频，具体 A1 运行见视频 1。


# 二、四足机器人双足行走

## MDP

**状态空间：（217dim）**

| 状态     | 维度  | 缩放       |
| ------ | --- | -------- |
| 基体的线速度 | 3   | 2        |
| 基体的角速度 | 3   | 0.25     |
| 基体重力向量 | 3   | 1        |
| 基体指令速度 | 3   | 2、2、0.25 |
| 关节位置差值 | 6   | 1        |
| 关节速度   | 6   | 0.05     |
| 上一时刻动作 | 6   | 1        |
| 高度测量   | 187 | 5        |

**动作空间：（6 dim）**

由于将前腿固定，因此动作输出为后腿各个关节的相对目标位置：
$p_d$： target angle = actionscale * action + defaultAngle
通过 PD 控制器，利用目标位置差值转换成力矩信息后在输入仿真器中进力矩控制
$$
\tau = K_p*(p_d- p) - K_d* (v)
$$
**奖励函数：**

| 超参数                | 奖励系数     | 说明                      |
| :----------------- | -------- | ----------------------- |
| tracking_ang_vel   | 1        | z 轴角速度跟踪奖励              |
| tracking_lin_vel   | 1        | xy 轴线速度跟踪奖励             |
| lin_vel_z          | -1       | z 轴线速度惩罚                |
| ang_vel_xy         | -0.1     | xy 轴角速度惩罚               |
| Joint torques      | -0.00002 | 关节力矩惩罚                  |
| feet_air_time      | 5        | 保持正常行走奖惩                |
| stand_still        | -1       | 无运动惩罚                   |
| dof_acc            | -2.e-7   | 关节加速度惩罚                 |
| termination        | -200     | 提前结束惩罚                  |
| dof_pos_limits     | -1       | 关节位置限制惩罚                |
| reward_orientation | -1       | 方向惩罚（基于机器人本体 X 方向向上的差值） |
| collisions         | -1       | 碰撞小腿、大腿、臀部、关节惩罚         |


## 训练过程描述
参照 A 1 、 Cassie 奖励设计以及题目的提示，进行奖励和状态空间的调整。
本次共进行 30 多次的训练，训练过程四个阶段：趴着走、跪着走、双脚跳着走（原地蹲起）、正常走

1 A1出现趴着走的情况
**解决方法：** 修改机器人初始位置，将基体绕 y 轴旋转 90 度，并在终止项中增加前腿的终止条件`terminate_after_contacts_on = ["base","FR_foot","FL_foot"]`

2 A 1双脚跪着走的问题
**解决方法：** 增加关节的接触惩罚，无运动惩罚

3 A 1 跳着走（原地蹲起）的问题
**解决方法：** A 1 初始时将基体绕 y 轴旋转 90 度，导致基体 x 、z 轴方向改变，基体 x 轴指向上，z 轴指向后，因此出现指令速度和基体速度不匹配的情况，接下来就对奖励函数与基体方向进行适配，修改的奖励函数包括：`_reward_lin_vel_z`、`_reward_tracking_lin_vel`、`_reward_tracking_ang_vel`、`_reward_ang_vel_xy`、`def _reward_orientation`

4 正常走后对相关超参数微调，优化行走步态，来回晃动
**解决方法：** 增加 xy 轴角速度惩罚 

# 三、速度估计

## 速度估计网络

**输入（75dim）：**$o_t$

| 状态              | 维度  | 缩放       |
| --------------- | --- | -------- |
| 基体的角速度          | 3   | 0.25     |
| 基体重力向量          | 3   | 1        |
| 基体指令速度          | 3   | 2、2、0.25 |
| 关节位置差值          | 6   | 1        |
| 关节速度            | 6   | 0.05     |
| 历史关节位置差值（前三个时刻） | 18  | 1        |
| 历史关节速度（前三个时刻）   | 18  | 0.05     |
| 前三个时刻动作（相对目标位置） | 18  | 1        |

**输出 （3dim）：** $\hat{x_t}$

基体线速度 estimated_line_vel（x、y、z）

**损失函数**
基体线速度估计值和真实值的均方误差
MSE (estimated_line_vel, true_line_vel)

## PPO

**Actor**
输入：历史状态信息+基体线速度估计值$o_{t} + \hat{x_{t}}$  78dim
输出：相对目标关节位置 $a_t$   6dim 

**Critic：**
输入： 历史状态信息 + 基体线速度真实值 $o_{t} + x_{t}$  78dim
输出：状态价值 1dim

## 训练过程描述

由于缺少高度信息的检测，无法提前判断地形环境做出动作的改变，高难度地形难度对机器人快速适应性也要求比较高。因此，主要通过降低金字塔式斜坡地形的坡度`pyramid_sloped_terrain`

与加入




思考四足和双足的区别是什么？
- 12 自由度变 6 自由度
- 初始位置需要调整
- 奖励函数调整


固定六自由度，先是趴着，增加前腿终止惩罚，然后是跪着不动，跪着走后期 (调整碰撞惩罚)，调整初始初始位置, 修改奖励只为正，身体前倾跳着走。

在原地蹲起
绕 y 轴旋转 90 度，导致 x 轴方向改变，从而速度指令无法很好设置。
修改奖励项。