# 决策与规划



## 一、 路径规划
路径规划解决无人车从起点到终点，走怎样路径的问题。规划的总体要求是不要撞到障碍物、保持自身的安全和可能相遇的车辆和行人的安全，在此基础上，依次追求以下目标：车体平稳、乘坐舒适、寻求路径最短。


### 1. 全局路径规划

给无人车设定目的地，从出发到目的地走哪条路最好。

### 1.1 简述

**简述**：路径规划是指在在一定的环境模型基础上（全局地图数据库信息），给定自动驾驶汽车的起始点和目标点后，按照性能指标规划出一条无碰撞、能安全到达目标点的最优全局路径。路径规划通常是指**全局的路径规划**，也可称为全局导航规划，从出发点到目标点之间的纯几何路径规划，无关时间序列，无关车辆动力学。

**全局路径规划**：全局路径规划是由获取到的地图信息，规划出一条在特定条件下的**无碰撞最优路径**。

> 在电子地图、路网以及宏观交通信息等先验信息下，根据某优化目标得到两点之间的最优路径，常见于卫星定位导航等，完成路径规划的传感信息主要来自GPS定位信息以及电子地图。

**任务描述**：智能驾驶中进行道路、车道和行驶三级任务分工

- **道路级**：全局的任务规划
- **车辆级：** 根据周边交通状况规划运动轨迹
- **行驶级：** 根据前后车进行智能运动控制



> 接收到传感感知融合信息，通过智能算法学习外界场景信息，从全局的角度规划具体行驶任务，从而实现智能车辆拟人化控制融入整个交通流
>
> 交通流的复杂度借助信息传递影响规划人物的复杂程度，从而决定智能驾驶动作。
>
> 不断实时的监督车辆运动状态和周围环境信息，当探测到当前道路阻塞时，要求重新规划任务，并做分解调整。



> 根据车辆当前的位置从路网中选择一条最优的路线到达目的地，路网通常由有向图表示，边的权重表示经过这条路线的成本，由此可以在路网中找到一条花费最小的路线。对于有向图的最短路径问题，有两种经典的算法：Dijkstra和A*



### 1.2 基于图搜索的路径规划算法

自动驾驶环境系统通常简化为有向网格图（Directed Graph Network；DGN），该图能够表示道路与道路之间的连接情况、通行规则、道路的路宽等各种信息，这个有向图也被称为路网图（Route Network Graph；RNG），自动驾驶车的路径规划问题可以转换为一个有向图搜索问题，处理此问题的成熟算法主要有：基于图搜索的方法、基于采样的方法、基于最优化的方法、基于曲线拟合轨迹规划算法。

#### 方法简述：

利用一定的方法将自动驾驶车辆所在空间的环境模型转换成**离散图**，在满足搜索算法约束下从图中计算出行驶路径。图中每个节点表示状态空间的一个离散状态，节点之间的连接表示状态跳转。



#### 构建图方法（离散图）：

- **维诺图**：源于计算机图形学，构造维诺图需要依靠障碍物顶点，生成的路径有较好的平滑性，但是未必时最优路径。

- **栅格法**：将车辆所在的工作空间根据一定的规律分解成若干方形栅格，分解实时性较高，但该方法**适用于地图分辨率不高的场景**。



#### 图搜索方法：

**1. Dijkstra算法**：单源点最短路径算法，计算出一个节点到其他所有节点的最短路径。

基于广度优先搜索算法，从根节点开始，沿着树的宽度遍历树的节点，如果所有节点均被访问则算法终止，广度优先搜索算法是在所有方向上均匀搜索。

> Dijkstra能找到最短路径，但是需要遍历整个地图，由于搜索过程中没有目标，对于复杂环境时分耗时。

**2. A\*算法**： Dijkstra算法加入启发估算函数来决定每个节点搜索的权重，慢慢向目标靠近，用于加速运算。

计算一个**成本函数**，选择成本函数最低的节点作为接下来要前往的节点：
$$
f(x) = g(s) + h(x)
$$
- $g(x)$： 表示起始节点到当前节点路径长度；
- $h(x)$：启发式函数，当前节点到目标节点的估计值，通常用欧式距离表示。

  > 启发式函数的作用是引导搜索向目标节点扩展，减少搜索所需的状态节点，从而提高效率。



### 1.3 基于最优化的路径规划算法

自动驾驶的汽车的路径规划问题可以用多目标优化问题来描述，利用**目标函数**对规划问题进行描述（对无人车姿态和环境约束条件建模），并利用**数值优化**的方法对其进行在线求解，从而得到最优轨迹。基于优化的方法，包括基于状态空间的最优控制、凸优化。

**最优控制方法**：将车辆视为一个动态系统，建立满足车辆动力学的状态空间方程，通过设计目标函数增加约束条件和任务目标。

> 由于在最优控制方法中考虑时间的因素，因此生成的最优轨线是轨迹而不是路径，轨迹具有曲率连续的优点，且生成的轨迹中包括和时间相关的速度、加速度等轨迹特征量。 



### 1.4 基于随机采样的路径规划算法

基于随机采样的路径规划算法是**概率性**算法，通过对工作空间的采样来评估连通性信息，这一随机采样的策略针对复杂问题可以快速找到可行解。实在Dijkstra算法的基础上改良的，为了减少计算量，加入了启发式算法，配合随机采用，只计算样本中最短路径，解决了计算量的问题，但路径可能不连续。

**缺点**：
- 但由于其随机性，找到的解通常是次优解。
- 基于随机采样的路径规划算法不能保证在一定时间内针对所有问题都能找到解，也就是完备性问题。

**方法**：随机势规划（RPP）算法、随机路标图（PRM）算法、**快速搜索（RRT）树**、扩展空间树（EST）算法等。

**过程**：采样、度量、最近邻搜索、父节点搜索、局部优化、碰撞检测。
**RRT算法：**

是一种采用**增量方式**增长的随机采样算法，RRT算法是基于初始点和目标点进行随机采样，增量式地生成随机树。它将初始点作为随机数的根节点，通过随机采样，增加叶子节点的方式，不断向四周扩展，构造一个随机扩展树。

它可以快速的搜索整个可行域，到那时它的主要缺点在于其创建的干扰路径以及在树的扩展过程中对最近邻居的度量标准有很强的依赖性。

> 在路径规划方面，搜索最近路径主要有两种方式，增量式方法和局部搜索。其中局部搜索的方法主要有：人工势场法、矢量柱状图（VFH）算法、模糊逻辑算法、遗传算法、蚁群算法、神经网络算法等。



### 1.5 基于曲线拟合的路径规划算法

规划算法中，可以通过计算机图形学相关技术对若干路点进行路径平滑，综合物理可行性、车辆动力学、舒适性等因素来拟合车辆轨迹。

**曲线拟合算法将离散节点拟合成斜率连续的平滑路径**， 一般可以通过高阶多项式、Dubins曲线、Reeds-Sheep曲线、贝塞尔曲线等方式实现。常用的曲线拟合算法包括：直线和圆弧、Clothoid曲线、多项式曲线、三次样条曲线、B样条曲线。

**1. 多项式曲线**：

根据给定节点处的研究对象的状态信息，在给定约束条件下获得曲率连续可导的路径。如果约束条件不满足，必须对整条轨迹进行调整来满足约束条件的要求，计算量较大、使其应用受限。

> 贝塞尔曲线式一种光滑插值曲线，有多个给定节点共同控制其形状。Dubins曲线由直线线段和不同半径的圆弧组成，虽然考虑到了系统的非完整性约束，却无法处理复杂碰撞情况。Reeds-Sheep曲线在Dubins曲线基础上有了更强适用性，它允许自动驾驶车辆在行驶过程中执行倒车操作。

**2. 三次样条曲线**：

从车道地图获得的一组航路点的中心线，生成一系列三次样条的参数，其使用弧长和偏移到中心线来表示可能的路径候选，避免了静态和移动障碍，然后这些候选都被转换为笛卡儿坐标。考虑到静态安全性、舒适性和动态安全性的总成本，该方法选择最佳路径的同时还确定了最佳路径的适当加速度和速度，包括单车道道路和具有静止与移动障碍物的多车道的道路。

**3. B样条曲线**：

由一组称作控制点的向量来确定，这些控制点按顺序连成一个控制多边形，B样条曲线就是逼近这个控制多边形。B样条曲线具有曲率连续的优点，在相邻曲线段的节点处曲率也是连续的，且具有局部支撑性等特点，如果轨迹局部的约束条件不满足，可以通过调整相应控制单的方法来对轨迹进行修正，从而不影响其他的轨迹段，具有应用性强的特点。





### 二、 运动轨迹规划

在行进过程中，遇到障碍物、行人、车辆等，怎样获得理想的行进路径，利用卫星定位和自身保存的离线地图规划出理想路径。

### 2.1 简述

运动规划可理解为局部路径规划和速度规划，也可理解为常说的运动轨迹规划。

**运动轨迹规划**：在静态路径规划的基础上考虑时间因素和车辆的动力学、运动学等约束条件，根据车辆当前的位姿以及传感器收集到的周围环境的状态信息，为提升智能汽车安全、高效和舒适性能，规划出可行的运动轨迹，包括行驶轨迹、速度、方向和状态等。最后将轨迹、车速等信息以控制量的方式供给到后续的控制系统，使得车辆可以沿着相应的轨迹行驶，避免碰撞。

> 轨迹规划能对任务决策层产生的各种任务分解做出合理规划，规划结果的安全性、舒适性是衡量运动规划层性能的重要指标

**原因**：全局路径规划所生成的路径只能是从起点到目标点的**粗略路径**，并没有考虑路径的方向、宽度、曲率、道路交叉以及路障等细节信息，加之车辆在行驶过程中受局部环境和自身状态的不确定性的影响，会遇到各种不可测的情况。

**任务**：生成一条轨迹，并将其发送到对车辆进行实际控制的反馈控制模块。



**局部路径规划**：全局路径规划的引导下，根据实时获取的环境信息，以及定位信息，规划出可以**安全避障并能跟踪全局路径的局部期望路径**，最终到达目标点的过程。局部路径规划输出的是一条满足车辆运动学约束、几何学约束的曲率连续的局部期望路径。

> 环境信息主要来自车载传感器如雷达、相机等，用以识别道路障碍、车道线、道路标识信息和交通信号灯信息等。

**速度规划：** 在局部期望路径基础上系统的考虑驾驶安全性、乘坐舒适性等约束，规划出车辆行驶的速度曲线。



### 2.2 局部路径规划方法

智能汽车进行局部路径规划（实时路径规划），一般是指在有障碍物的环境中，利用自身传感器感知周边环境，寻找一条从当前点到目标点的局部行驶路径，使智能汽车在本次任务中能安全快速的到达目标位置

**关键步骤：**

- 建立**环境模型**， 即将智能汽车所处的现实世界抽象后，建立计算机可认知的环境模型。
- **搜索无碰撞路径**，即在某个模型的空间中，在多种约束条件下，选择合乎条件的**路径搜索算法**， 

**局部路径规划方法**：

- **基于滚动时域优化的轨迹规划方法**：依靠智能汽车通过传感器实时探测到的局部环境信息，以滚动的优化的方式进行在线规划。反应速度快，能快速适应变化的环境，但是计算量相对较大。
- **基于轨迹片段的运动规划方法**：轨迹片段包含配平轨迹和机动轨迹。可以通过考虑车辆的运动学和动力学约束条件，基于最优控制原理和机动轨迹设计方法和随机采样法，实现基于轨迹片段的连接的最优运动轨迹规划和快速运动规划。较为复杂，在实际应用中受限。
  - 配平轨迹：系统处于相对平衡时所经历的轨迹
  - 机动轨迹：系统从一个相对平衡的跃入另外一个相对平衡所经历的轨迹。



### 2.3 动态窗口局部运动规划算法（DWA）

设定一个模拟周期，在此周期内充分考虑自动驾驶汽车的初速度、车的运动模型、自身硬件的性能因素，模拟车体在当前环境下的速度采样空间，对所有速度轨迹利用**评价函数**进行评价，从动态速度窗口中选择评价最高的速度，从而规划车体下一时刻的运动 。

DWA算法是一种对局部环境进行规划的算法，在运行过程中考虑当前最优速度，在实际应用中要与全局路径规划结合。动态窗口局部运动规划算法具有很好的稳定性和避障效果等优势。



## 二、 行为决策

### 3.1  简述

**简述**：无人车通过车辆传感器感知到交通环境信息，考虑行驶区域、动静态障碍物以及车辆汇入和让行规则，与无人驾驶行为库中的各种决策知识、经验相匹配，进而选择合适当前道路交通环境的驾驶行为。行为决策模块在**宏观**上决定了无人车如何行驶。

**任务：** 权衡所有的输入信息，做出有效和安全的决策；这些原始的输入包括路径规划模块的输出、无人驾驶车辆自身的属性、无人驾驶车辆历史信息、周围的障碍物信息、交通和地图信息、当地的交通规则。行为决策包括行驶、 跟车、转弯、换道和停车等。

驾驶行为决策后，其结果交给运动规划模块，运动规划模块与行为决策功能模块紧密协调配合，进行纵向的轨迹规划和横向的速度规划。

**行为决策方式**：基于规则的行为决策方法 和 基于强化学习的行为决策方法。



### 3.2 基于规则的行为决策方法

**简述**：基于规则的行为决策方法主要按场景划分，其核心思想是利用**分治原则**，将车辆周边环境分解成有层次的场景并单独解决。在单个场景中，根据本车道的车辆数据、道路基础设施和道路目标物数据，以及交通运行数据和用户出行要求等信息，运用对应的规则对汽车的驾驶行为及其参数进行决策。再将划分的单个场景的驾驶行为决策进行综合，得出最后综合的行为决策。

**评价**：基于规则的行为决策方法易于搭建和调整、实时性好、应用简单，但是该模型忽略了环境的动态性和不确定性，此外，当驾驶场景较多时，状态的划分和管理比较繁琐，多适用于简单的场景下。



### 3.3 基于强化学习的行为决策

**简述**：用于描述和解决智能体与环境的交互过程中，通过学习策略迭代，经验回放，损失函数设计，以达成回报最大化或实现特定目标的问题。

**马尔可夫决策**：强化学习的研究都是建立在马尔可夫决策过程基础上。马尔可夫决策模型提供了一个最底层的数学架构，用于面对部分条件随机情况，或者部分条件可由决策者控制的情况下进行决策。

> **马尔可夫决策过程**是指决策者周期性地或连续性地去观察具有马尔可夫性的随机动态系统，依据时间先后做出决策， 即根据每个时刻观察到的状态，从可用的行动集合中选用一个行动做出决策，系统在将来时间的状态是随机的，并且系统状态转移的概率具有马尔可夫性。

**评价**:传统的基于规则的行为决策系统，往往只能采取非常保守的驾驶策略，需要认为设计精细的规则用来应对复杂情况，且传统的方法忽视了车辆之间、车辆与行人之间的互动性。而强化学习可以从人类的驾驶样本中学习相应的的策略决策，并能将决策泛化到类似的驾驶情景中。不过深度强化学习难以解释，一旦系统发生故障无法进行针对性的改进，而人为构建选项图之后，每个决策细分为对应动作，再由神经网络控制，决策的整个推理过程的可解释就增强了。



## 四、 异常处理

**简述**：作为预留的智能驾驶系统安全保障机制，

- 一方面是在遇到不平、复杂路面，易造成车辆机械部件松动、传感部件失效等问题时，通过预警和容错控制维持车辆安全运行；
- 另一方面是在决策过程中，由于某些参数设置不合理，推理规则不完备等因素导致智能车在行为动作中重复出现某些错误并陷入死循环时，能够建立错误修复机制使智能汽车自主地跳出错误死循环，朝着完成既定任务的方向继续前进，以减少人工干预来解决问题。

**技术方法**：

- 建立**专家系统**，就智能汽车交叉路口通行时出现的错误状态的表现与成因进行分析、定义与规则描述，制定判断动作失败的标准；
- 研究**自适应错误修复算法**，对各错误状态的成因进行分类，并相应的制定调整策略，以产生新的动作序列。

