
**近期主要内容**：最近，主要工作是参考 Ray 官方案例，利用 RLlib 设置适当的超参数来训练导弹，并进行可视化测试以验证其效果。
- [x] 算法可视化测试
- [x] RLlib 训练

**目前进度**：已经完成了使用 RLlib（2.3.1）框架与自定义的单一导弹环境进行交互的基础设置，接下来我将依据可视化测试结果和日志信息（利用 tensorboard 进行可视化）来进行模型的训练和调参工作。
![[飞行器/img/box2d21.png]]


# 算法可视化测试

**目的：** 在训练过程中，为了评估算法的训练性能，可以选择固定的时间间隔或训练轮次来进行测试。这样做的好处是，当智能体的表现非常糟糕时可以提前结束训练，节约训练成本；方便修bug和调参。通过可视化可以直观的看到当前阶段的训练成果。

**问题描述：** 先前，仅基于 Gym 环境，已经实现了算法的可视化测试。但是，在加入 Ray 框架后，无法实现算法与环境交互的可视化界面。

**问题解决：** 
-  运行几个官方案例，发现已有的官方环境可以进行可视化，但是自建的环境仅能与算法进行交互，无法实现可视化展示，同时我也尝试将自建的环境通过 Ray 提供的方式进行注册，但并未解决该问题。
-  查阅官方文档，尝试了在 `config` 中加入 `render_env`、`monitor`、`record_env` 等参数，但并未解决该问题。
-  参考Ray RLlib的Algorithm API ，完成Gym、Ray的环境注册，最后按照RL范式自行编码实现了算法的可视化测试。
![[box2d20.png|400]]

# 训练调参总结

临近毕业，实验室服务器使用率较高且近期经常发生崩溃的情况，所以将导弹的训练任务转移到自己的笔记本上来进行，因此可能会导致训练的周期较长。


**问题 1**：在训练过程中，经常会发生回报特别高的情况（如下图左侧打印的回报所示），通过打印状态、动作以及通过可视化展示发现，导弹会存在超出设定的区域范围时（最大x、y坐标值），仍会正常运行且会获得较大的正奖励。
![[box2d19.png|400]]
**问题解决**：
在原有终止条件中增加一个超出区域范围的终止条件，即导弹的坐标超出设定的最大x、y值时，智能体和环境的状态会重置，且智能体此时会获得一个较大的负奖励。

--------
**问题 2**：在 Baseline 任务中（LunarLander）并未设置 max_episode_steps，因此通过 `trainer.train()` 训练时，会一直运行下去。由于当前 Ray 版本较高，网上提供的几种常见解决方法（例如设置 `config[horizon]` 等）无法解决该问题。
```shell
Your env doesn't have a .spec.max_episode_steps attribute. Your horizon will default to infinity, and your environment will not be reset.
```

**问题解决**：
1. 参照 [rllib/tuned_examples/ppo/cartpole-truncated-ppo.py](https://github.com/ray-project/ray/blob/9432c9ec6e083177bda0cf6fa6e64c940f44156f/rllib/tuned_examples/ppo/cartpole-truncated-ppo.py#L6) 环境注册方式修改之前 ray 环境注册方式；
2. 在导弹环境（`class: One_Missile_Env`）初始化时加入 `max_episode_steps` 作为形参；
3. 在`step`方法中完成超时逻辑的编写，并返回超时的结果`bool: truncated`。
```python
env_name = "One_Missile_Env-v0"
gym.register(
    id=env_name,
    entry_point='env.one_missile_env:One_Missile_Env',
)
env = gym.make(env_name, render_mode="human")

# replace  
# tune.register_env(env_name,lambda config: One_Missile_Env(config))
tune.register_env(
    env_name,
    lambda _: TimeLimit(env, max_episode_steps=800),
)
```

-----

**下周任务**：
- 根据可视化测试结果调整参数
- 根据Ray框架的开发者文档，进一步探索Ray框架的功能和用途（例如：超参数优化库Tune、分布式任务、矢量化环境适配等）
