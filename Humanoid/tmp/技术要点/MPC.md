下面是一套基于 MIT 常用的 MPC（Model Predictive Control）框架，用于六自由度人形机器人**末端足底接触力规划**，以实现机器人对设定速度的跟踪。该方案包含从运动学到动力学建模、再到 MPC 求解和实时执行的完整实现思路。为方便说明，以下步骤基于世界坐标系进行解释，但在实际实现时可根据需要在局部坐标系与世界坐标系之间转换。

MPC 算法整体流程：MPC 控制框架下，我们希望找到一个最优的足底接触力，使机器人跟踪指定轨迹。
1. **运动学建模**：三个坐标系（世界坐标系、机体坐标系和足底坐标系）。正运动用于计算足底相对于世界坐标的位姿；逆运动学计算足底位姿对应的关节角。
2. **动力学建模：** 将人形机器人视为一个刚体集中在质心的单刚体模型
3. **状态空间建模**： 将连续时间下的非线性动力学方程离散化成离散时间系统，通常在每个采样时刻（状态向量，控制向量）附近作一阶近似线性化，的到离散时间系统矩阵
4. **目标函数：** 在一个预测时域 N 步内，最小化跟踪误差和控制代价。
5. **约束条件：** 系统动力学约束、关节力矩约束、脚底摩擦锥约束、最大接触力、足底运动学约束。
6. **在线优化求解：** 将目标函数和约束离散化后，的到一个典型的带约束的二次规划，在时域内最小化目标函数，得到控制输入序列，应用第一个控制量，左乘雅可比矩阵转置得到关节力矩，更新系统状态进行滚动优化。





---

## 1. 明确系统需求与目标

7. **机器人本体：** 具有六个可动关节（或简化为六个关键自由度）的双足人形机器人。
8. **控制目标：**
   - 通过规划足底接触力，调节关节力矩，实现机器人躯干在轨迹或速度方面的跟踪（例如前进或其他方向上的设定速度）。
   - 维持步态稳定，不出现脚底打滑或坠落。

9. **MPC 框架：**
   - 预测时域长度为 $N$ 个离散步。
   - 在每个控制时刻，求解足底接触力和关节力矩的最佳分布，以最小化跟踪误差与能量消耗，并满足物理与运动学约束。

---

## 2. 运动学建模

### 2.1 坐标系定义

10. **世界坐标系（WCS）：** 记为 $\{W\}$，固定在地面上，用于描述机器人的绝对位置和姿态。
11. **机体坐标系（BCS）：** 记为 $\{B\}$，通常放置在机器人躯干质心或基座。
12. **足底坐标系：** 记为 $\{F_i\}$，与每只脚的触地点相关。

### 2.2 关节参数

对于六自由度（6-DOF）人形机器人，通常每条腿有 3 个关节自由度（如髋、膝、踝）。为简化，可以只考虑这些关键自由度，设广义坐标为
$$
Q = [\, q_1, q_2, \dots, q_6 \,]^T
$$
其中包含两条腿主要关节的转角。

### 2.3 正逆运动学

13. **正运动学：** 计算足底相对于机体或世界坐标系的位置与姿态
   $$
   \begin{aligned}
   {}^{W}T_{F_i}(q): q \longrightarrow \{F_i\} \text{相对于} \{W\} \\
   \end{aligned}
   $$
   其中 ${}^{W}T_{F_i}$ 是从世界坐标系到足底坐标系的齐次变换矩阵，包含平移和旋转信息。

14. **逆运动学：** 根据期望的足底位置与姿态，计算所需关节角
   $$
   Q = IK\bigl ( {}^{W}T_{F_i}^{\text{des}} \bigr)
   $$
   在 MPC 过程中会涉及到足底可能的摆动范围和接触位置的可行性分析，但通常 MPC 最终优化的是力／力矩而非关节角度，逆运动学可用于在线或离线动态可行性验证。

---

## 3. 动力学建模
### 3.1 整体动力学
人形机器人在双足状态下的动力学方程可用欧拉-拉格朗日形式表达 (世界坐标系中表征)，并结合足底接触力进行扩展。对于每条腿联系在机体上的情况，整体动力学可写为：

$$
M (q)\,\ddot{q} \;+\; C (q, \dot{q})\,\dot{q} \;+\; g (q) \;=\; \tau \;+\; \sum_{i \in \text{foot}} J_i^T (q)\, F_{c_i}
$$

其中：
15. $M (q)$ 为惯性矩阵，随关节角度 $q$ 变化。
16. $C (q, \dot{q})$ 表示 Coriolis 和离心力。
17. $g (q)$ 表示重力项。
18. $\tau$ 为关节力矩向量（控制输入）。
19. $F_{c_i}$ 表示某只脚在接触地面时的足底接触力（包含三维力和相应的力矩，也可拆分成力与力矩两部分）。
20. $J_i (q)$ 为足底接触点对应的雅可比矩阵，用于将足底坐标系中的力转换到关节空间。

### 3.2 足底接触模型

21. **接触力表达：** 对于每只脚，若其与地面接触，则可在世界坐标系下表示为
   $$
   F_{c_i} = 
   \begin{bmatrix}
   F_{x_i} \\
   F_{y_i} \\
   F_{z_i} \\
   \tau_{x_i} \\
   \tau_{y_i} \\
   \tau_{z_i}
   \end{bmatrix}
   $$
   在多数情况下，主要关注平动力（$f_{x_i}, f_{y_i}, f_{z_i}$）即可，用于支撑或加速机器人，转动力矩 ($\tau_{x_i}, \tau_{y_i}, \tau_{z_i}$) 在简单模型中可忽略或简化处理。

22. **摩擦锥约束（或多面体近似）：**
   $$
   \sqrt{f_{x_i}^2 + f_{y_i}^2} \;\le\; \mu \, f_{z_i}, 
   \quad f_{z_i} \ge 0
   $$
   确保不发生打滑，如果要考虑脚底力矩则需对 $\tau_{x_i}, \tau_{y_i}, \tau_{z_i}$加入相应的滑动或翻转约束。

23. **单脚/双脚支撑期：**
   - 在双足支撑期内，两个脚都提供支撑力；
   - 在单脚支撑期 (另一个脚抬起或摆动)，只有一个脚提供支撑力，另一个脚力可认为为 0（或不进入约束）。

---

## 4. 状态空间与离散化

### 4.1 状态向量与控制向量

为在 MPC 中进行预测，需要定义系统的状态向量 $x$ 和控制向量 $u$。常见的形式为：

- **状态向量** $x_k$:
  $$
  x_k = \begin{bmatrix}
  q_k \\ 
  \dot{q}_k
  \end{bmatrix}
  $$
  包含关节位置与关节速度（也可额外加入足底力或质心状态）。

- **控制向量** $u_k$:
  $$
  U_k = \begin{bmatrix}
  \tau_k \\
  F_{c, k}
  \end{bmatrix}
  $$
  即关节力矩和（可能）足底接触力。根据具体实现需求，可能只将 $\tau_k$ 作为优化变量，将接触力作为辅助变量，也可以将接触力一同纳入优化。

### 4.2 动力学离散化

在连续时间下的动力学方程（非线性）离散化成离散时间系统，用于 MPC 求解：

$$
X_{k+1} = f (x_k, u_k)
$$

由于是非线性系统，通常在每个采样时刻 $(x_k, u_k)$ 附近作一阶近似线性化，得到：

$$
\delta x_{k+1} = A_k \, \delta x_k + B_k \, \delta u_k
$$

其中 $A_k, B_k$ 为在当前工作点线性化后得到的离散时间系统矩阵， $\delta x$ 和 $\delta u$ 分别是对线性化工作点的增量。

---

## 5. MPC 优化问题的构建

### 5.1 目标函数

MPC 在一个预测时域 $N$ 步内，最小化跟踪误差和控制代价。典型的目标函数可以写成：

$$
J = \sum_{k=0}^{N-1} 
\Bigl[
(x_k - x_{ref, k})^T Q (x_k - x_{ref, k}) 
\;+\;
(u_k - u_{ref, k})^T R (u_k - u_{ref, k})
\Bigr]
\;+\;
(x_N - x_{ref, N})^T P (x_N - x_{ref, N})
$$

$$
J = \sum_{k=0}^{N-1}\left\|\boldsymbol{x}_k-\boldsymbol{x}_{\mathrm{ref}, k}\right\|_Q^2+\left\|\boldsymbol{u}_k -\boldsymbol{u}_{\mathrm{ref}, k} \right\|_R^2+\left\|\boldsymbol{x}_N-\boldsymbol{x}_{\mathrm{ref}, N}\right\|_P^2
$$

24. $x_{ref, k}$ 为期望状态（可包含期望步态，或者在本例中可以是期望质心速度等）。
25. $u_{ref, k}$ 为参考控制输入（若有）。
26. $Q, R, P$ 分别为状态偏差、控制偏差与终端偏差的权重矩阵。在行走速度跟踪场景下，可在 $Q$ 中加大“线速度”相关项的权重。

### 5.2 约束条件

27. **系统动力学约束：**
   $$
   X_{k+1} = f (x_k, u_k), \quad \text{或其线性化形式} \;
   \delta x_{k+1} = A_k \delta x_k + B_k \delta u_k
   $$

28. **关节力矩约束：**
   $$
   \underline{\tau}_j \;\le\; \tau_{j}(k) \;\le\; \overline{\tau}_j
   $$

29. **脚底摩擦锥（或多面体）约束：**
   $$
   \sqrt{f_{x_i}^2 + f_{y_i}^2} \le \mu f_{z_i}, \quad f_{z_i} \ge 0
   $$

30. **最大接触力／冲击力约束（选配）：**
   $$
   \|F_{c_i}\| \le F_{\max}
   $$

31. **末端几何可达性约束（运动学约束）：**
   $$
   \|p_{F_i} - p_B\| \le d_{\max}
   $$
   确保足底不会超过腿部连杆运动范围。

---

## 6. 优化求解与在线实现

### 6.1 整体优化形式

将上述目标函数和约束离散化之后，得到一个典型的带约束的二次规划（Quadratic Programming, QP）或非线性规划（Nonlinear Programming, NLP）问题。 

若使用线性化后得到近似二次目标和线性不等式约束，则可表示为：

$$
\min_{U} \;\; 
\frac{1}{2} U^T H U + f^T U
\quad
\text{subject to}
\quad
\begin{cases}
G U \le h \\
E U  = e
\end{cases}
$$

其中 $U$ 在预测时域上拼接了所有 $u_k$ (也可包括 $\delta x_k$ 的变量)。$H$ 和 $f$ 分别对应二次项矩阵和线性项系数，受系统线性化及约束的定义。

### 6.2 快速求解

由于 MPC 需要实时更新，一般要求解算器速度快、稳健性好。常见的快速 QP 求解器包括：

- [OSQP](https://osqp.org/)
- [qpOASES](https://github.com/coin-or/qpOASES)
- [HPIPM](https://github.com/giaf/hpipm) 等

对于更复杂的非线性问题或高维情况，也有基于 SQP、IPOPT 等工具的实现，但可能需要做额外的模型降维或启发式处理确保实时性。

### 6.3 循环执行

32. **实时更新状态：** 通过传感器（关节编码器、IMU、力传感器等），获取当前实际状态 $x_k$。
33. **线性化：** 在 $(x_k, u_{k-1})$ 附近做一阶近似，生成线性化后的系统矩阵 $A_k, B_k$。
34. **预测与求解：** 在时域 $k, k+1, \dots, k+N-1$ 内最小化目标函数，求得控制输入序列 $\{u_k^*, \dots, u_{k+N-1}^*\}$。
35. **应用第一个控制量：** 在实际系统上应用 $u_k^*$，使机器人执行对应的力矩和足底力分配。
36. **滚动优化**：将时刻 $k+1$ 的状态更新为新的初始条件，重复上述步骤。

---

## 7. 框架整合与实施要点

37. **初始步态/状态生成**：提前给定初始支撑腿状态和足底力，以便第一步优化有合理初始值。
38. **状态/观测融合**：IMU、关节角、力传感器等信息需要经过滤波（如 EKF）融合，以得到平滑且精确的机器人质心、速度等估计。
39. **脚踝与足底传感**：在单足支撑与双足支撑的切换过程中，要及时更新接触力变量和相关约束。
40. **并行运算**：若使用高阶或长时域的 MPC，需充分利用多核 CPU 或 GPU 进行并行计算，以满足实时性。
41. **故障安全**：在实际的机器人系统中，若优化器出现求解不成功或传感器失效，应有安全策略，如退回既定安全姿态或切换到 PID 模式等。

通过上述步骤，人形机器人可在预测时域内对足底接触力作合理分配，让机器人朝着期望速度运动的同时保持平衡。MPC 的在线滚动优化对于外界扰动或模型不确定性具有较好的适应能力，能提高动态步态的稳定性和对环境的鲁棒性。



### 总结

以上所述流程涵盖了从**运动学建模**（正逆运动学、足底可达性）到**动力学模型**（关节力矩、足底接触力、摩擦锥约束）的建立，再到**MPC 优化结构**（目标函数、约束、离散化和求解器）的核心技术环节。该过程可在不同自由度数的人形机器人上进行定制化扩展或简化；关键在于确保模型与约束的物理一致性，以及在给定的计算预算内实现实时求解。通过该流程，人形机器人能够在足底接触力规划的 MPC 控制下，稳步跟踪设定的速度并保持平衡。