

# CASBOT 02

![alt text](image-25.png)
## 整体架构

### 电气架构

![[Electrical_architecture.png]]
该系统架构包含以下主要单元：
1. **RCU（Robot Control Unit，机器人控制单元）**
2. **PMU（Power Management Unit，电源管理单元）**
3. **各类传感器**（摄像头、IMU、深度相机等）
4. **执行机构（伺服电机）**
5. **通讯单元（CANFD / RS485 / Ethernet / UART）**
6. **供电系统（48V主电、12V辅电）**

### 软件架构

![[Pasted image 20250420041537.png]]

系统软件采用分层的设计思维，自下而上分别为硬件抽象层、设备驱动层、操作系统层、功能模块层、应用层，具体介绍如下：

**硬件抽象层**：用于处理与硬件交互的底层操作。它的主要职责包括配置片内外设的硬件寄存器、初始化外设、处理中断和时钟管理。通过抽象硬件细节，HAL 提供了一个统一的接口，使上层功能模块可以更方便地与硬件进行通信。本设计通过 STM 32 CubeMx 工具，自动生成硬件抽象代码。设备驱动只需要对硬件抽象的事件进行编程，可以更加专注于业务逻辑代码的开发。

**设备驱动层**：为上层应用程序提供外部设备的操作接口，并实现设备的驱动程序。每个设备都应该定义清晰的接口（对下至上）。在本设计中，承接 HAL 库外设事件的编程方法，设备驱动与硬件抽象主要通过注册回调函数的方式对接，具有低耦合的特点。

**操作系统层**：设计采用 RTOS 来管理软件的业务模块，在保证系统实时性的同时，通过 RTOS 提供的组件，进一步减少了模块之间的耦合；使用多线程的设计思路，降低了软件业务的设计难度，具备更强的可扩展性。

**功能模块层**：负责将系统功能划分为独立的、可复用的模块，每个模块专注于特定的任务或功能。每个模块都应该定义清晰的接口，以便与其他模块进行通信。功能模块之间的通信可以通过任务通知、消息队列等方式。

**应用层**：分层中的最高层，包含了系统的业务逻辑，负责实现特定的应用功能。在应用层，开发人员编写与具体业务需求相关的代码。

## 电源系统架构

整个系统的供电情况如下：

### 主电源（48VDC）

- 电池或电源模块为主要供电源，输出 **48V DC**。
- 供电到：
    - 伺服驱动器/电机
    - 电源管理模块（PMU）
    - RCU（通过DCDC转换提供12V、5V）

### 二级电源（12V, 5V）

通过 **DCDC 模块转换**获取不同电压等级：

- **DCDC (48V to 12V)** ：为RCU供12V。
- **DCDC (48V to 5V, 5A)** ：给摄像头和USB HUB模块供电。
- **PMU**中集成了多个DC转换器，输出12V/15A等供给驱动器和通讯设备。

## 电源管理单元 PMU

**Power Management Unit，电源管理单元） 主要负责给运算单元、关节等模块供电。** 机器人电源管理是确保机器人稳定运行的关键环节，涉及电源供应、电池管理、开关机、电源检测和处理等多个方面功能。嵌入式软件设计在机器人电源管理中扮演着重要角色，通过软件优化和控制，能够实现对电源的高效管理和利用，并在异常状态出现时，进行处理和报错。


### 设计目标

机器人电源管理嵌入式软件设计的目标主要包括以下几个方面：
- 确保电源供应的稳定性，保证各种场景下的开关机流程；
- 实时检测设备多个位置供电电压、温度等参数，在出现异常情况下，进行相应保护、报错，并在紧急情况下，快速实现设备各个模块的掉电保护；
- 状态信息上报以及下发控制信息响应；
- 电池 BMS 通信，检测电池状态信息；
- 异常状态日志存储与读取；
- 配置参数读写功能；

### 主要接口

1. 各支路供电电压为 42-58.8 V，过流保护能力 60 A，短路保护能力 90 A，主路及各支路供电电压和电流可监控；
2. 提供 12 V 供电给 RCU、HRU、IEB 接口板、ECAT 转接板；
3. 可实现有线急停和无线急停功能；
4. 可实现长按开关机功能；
5. 具有报警功能；
6. 具有 debug 功能；
7. 可接 433 模块，实现 LCD 无线显示功能；2 路 CAN FD 及 2 路 RS485；
8. 具有 1 路 PCB 板温度检测和两路腔体温度检测功能；
9. 具有带反馈的风扇控制功能；
10. 具有 RTC 功能；

### 软件架构
1. **操作系统**：
选用轻量级的嵌入式操作系统 FreeRTOS，搭配 STM 32 cubeMX 进行相关配置，满足实时性和稳定性要求。

2. **系统层次结构**：
机器人电源管理嵌入式软件采用模块化设计，包括开关机控制、电池管理模块、温度管理、风扇管理模块等。模块通过固定接口与 Server 进行通信和数据交互，实现功能的协同和整合，如下图。

机器人电源管理嵌入式软件采用模块化设计，包括开关机控制、电池管理模块、温度管理、风扇管理模块等。模块通过固定接口与 Server 进行通信和数据交互，实现功能的协同和整合，如下图。
![[image-14.png]]


基于 RTOS，任务为应用设计的最小单元，应坚持任务单一性原则进行设计。本设计共有 13 任务，根据任务对象的角色属性（生产者、消费者、服务端）进行划分，其中生产者有 4 个，消费者有 4 个，服务端 1 个，生产者兼消费者 3 个，无定义 1 个，具体任务归类及优先级如下表： 

| 任务                        | 属性      | 优先级 |
| ------------------------- | ------- | --- |
| 急停检测                      | 生产者     | 中断  |
| 过流检测                      | 生产者     | 中断  |
| RCU CAN 数据上行任务             | 生产者     | 1   |
| RCU CAN 数据下行任务             | 消费者     | 2   |
| Server 任务                  | 服务      | 3   |
| Power Management 任务        | 消费者     | 4   |
| BMS Read 任务                | 生产者     | 5   |
| LOG Management 任务          | 消费者     | 6   |
| Parameter Configuration 任务 | 生产者&消费者 | 7   |
| DEBUG 任务                   | 生产者&消费者 | 8   |
| ADC Read 任务                | 生产者     | 9   |
| Key Status 任务              | 生产者     | 10  |
| Buzzer 任务                  | 消费者     | 11  |
| Fan 任务                     | 生产者&消费者 | 12  |
| WatchDog 任务                | 无       | 13  |
|                           |         |     |
 
考虑到异常状态应第一时间进行处理，因此状态异常处理任务优先级设置为最高，检测类任务作为异常状态的数据生产者，优先级排在之后，然后是开关机类任务和通讯类任务，系统辅助类任务如日志管理任务、系统指示灯任务、蜂鸣器任务、风扇任务及喂狗任务优先级排在最后。


## 机器人控制单元 RCU

**RCU（Robot Control Unit，机器人控制单元），机器人控制单元就像是机器人的 “大脑”**，它负责接收来自各种传感器的信息，对这些信息进行分析处理，然后依据预设的程序和算法生成控制指令，从而驱动机器人的各个执行机构（如关节电机、末端执行器等）完成相应的动作任务。

RCU 上的 MCU 实现“大脑 ORIN”上下电逻辑，并与 ORIN 通过 SPI 通信，作为数据桥接，上报 PMU 的状态信息。**MCU 型号：STM32H723VGT6。**
![[image-13.png|500]]

### 设计目标

RCU 嵌入式软件设计的目标主要包括以下几个方面：
- 确保 ORIN 正常上下电以及休眠；
- 与 ORIN 通过 SPI 通信，进行数据桥接；
- 与 PMU 通过 FD CAN 通信，实现数据上报；
- 配置参数读写；
- OTA 功能。


### 主要接口

- 多路 USB 接口：连接相机（如 Intel D435i）、人机交互设备（手柄）、WIFI/4G 模块
- CANFD - 控制伺服控制器、马达驱动 和动态执行机构
- UART - 与传感器（IMU、温湿度）、按键板通信
- GPIO - 连接硬件按键、传感器控制信号
- Ethernet/千兆网口：使用EtherCAT与驱动器或外部设备高速通信
- 视频接口：连接摄像头、LCD显示屏



### 软件架构

**操作系统**：
选用轻量级的嵌入式操作系统 FreeRTOS，搭配 STM 32 cubeMX 进行相关配置，满足实时性和稳定性要求。

**系统层次结构**：
RCU 嵌入式软件采用模块化设计，包括 PMU 通信模块、ORIN 通信模块、ORIN 上下电模块等。各模块之间通过接口进行通信和数据交互，实现功能的协同和整合。


基于 RTOS，任务为应用设计的最小单元，应坚持任务单一性原则进行设计。本设计根据任务对象的角色属性（生产者、消费者、服务端）进行划分，共有 14 个任务，其中生产者有 3 个，消费者有 1 个，服务端 1 个，具体任务归类如下：
生产者：按键检测、 ORIN 下发控制、PMU 数据上行；
消费者：ORIN 上下电；
服务端：（Server）数据收集与逻辑处理
其中各个任务优先级如下表：

| 任务                 | 优先级 |
|----------------------|--------|
| RCU 数据上行任务      | 1      |
| RCU 数据下行任务      | 2      |
| Server 任务           | 3      |
| PmuCAN 任务           | 4      |
| ORIN PWR 任务        | 6      |
| Key 检测任务          | 13     |
| 独立看门狗喂狗任务   | 14     |


## 微控制器单元 MCU

**MCU（MicroController Unit）是指嵌入式系统中的微控制器单元**，是一种集成了 CPU、内存（RAM/ROM）、IO 端口、定时器、通信接口等功能的芯片。

在机器人中，它主要负责：

- 控制执行机构（电机、伺服）
- 处理中低速的传感器数据（如温度、电流、按钮状态等）
- 本地逻辑控制（例如时间逻辑、状态机）
- 与更高层控制器（如RCU）通信

MCU 适用于**实时响应强**、处理数据量较小但对周期性要求高的任务，比如：
- 电机转速控制
- PWM信号生成
- 广义IO控制（开关量/模拟量）

常见的MCU品牌有 STM32、NXP、TI MSP430、ESP32等。

|  项目  | MCU         | PMU                | RCU                  |
| :--: | ----------- | ------------------ | -------------------- |
|  本质  | 芯片 / 微控制器   | 模块 / 电源管理模块        | 模块 / 上层计算平台          |
| 执行内容 | 底层实时任务      | 电源转换与管理 (可能内嵌 MCU) | 上层控制任务：视觉、运动、决策      |
| 处理频率 | 高频实时（毫秒）    | 较低（依赖任务）           | 高级策略（~10 Hz 以上甚至实时）  |
| 示例任务 | 控电机 PWM/ADC | 输出 12 V/5 V，监测电流   | 步态规划/视觉 SLAM/动作优化    |
| 通信对象 | PMU、RCU、驱动器 | MCU、RCU            | MCU、PMU、摄像头、AI 处理单元等 |


## Ethercat 转CAN


| 项目 | CAN 通信 | EtherCAT |
|------|-----------|-----------|
| 最大速率 | 1 Mbps（CAN）/ 8 Mbps（FD） | ≥100 Mbps |
| 典型周期 | 1 ms–10 ms | 0.25 ms–1 ms |
| 同步性 | 无、需上层触发 | 内建 DC（<100 ns 同步） |
| 控制时间抖动 | 较大（仲裁机制影响） | 极小 |

在对**多自由度执行器精密同步**有更高要求的系统中，EtherCAT 更优，而 CAN 更适合结构简单、非强同步类设备。

### 需求目标

人形机器人在实际运行中，常常需要：
- 同步控制多个自由度（如**双足步态、双臂协同动作**）
- 控制关节驱动器（通常基于 **CAN 总线**）
- 控制手部/外设（常通过 RS485）

由于机器人控制需要**高精度同步、强实时性通信保障**，EtherCAT 涌现为主站通信标准；但底层设备多为 CAN，因此出现了 **“由 EtherCAT 主站控制多个 CAN 从站”** 的需求。

| 目标 | 说明 |
|------|------|
| ✅ 实时性 | 满足 EtherCAT 控制周期内（≤1 ms），实现同步发出控制指令到 CAN 节点 |
| ✅ 多节点支持 | 一个转换设备需支持 8 个 CAN 从站、4 个 RS 485 从站 |
| ✅ 安全性 | 支持集成掉线主动容错、紧急停机等保护功能 |

实现「EtherCAT 转 CAN」，是为了 **整合高性能主站控制与底层多设备通信的兼容性需求**。

### 实现方法

| 属性    | 内容                                           |
| ---- | -------------------------------------------- |
|       | 统一 EtherCAT 实时主控消息与底层 CAN 控制器通信格式            |
| 实 方法  | EtherCAT SoC + 多通道 CAN FD 控制 + 同步中断、DMA 转发   |
|  用场景  | 典型用于人形机器人关节驱动器、力位复合控制器、智能手爪、PMU、BMS 等多节点控制通 设计注意  设计注意 | 同步性、稳定性、电气隔离、协议栈兼容性需严格考虑                     |



***1. 硬件架构***

| 模块          | 说明                                                |
| ----------- | ------------------------------------------------- |
| MCU 主控芯片    | STM 32 H 723，适合 FOC 电机与多总线控制，支持高速中断与 DMA          |
| EtherCAT 从站 | SoC-E Slave 控制器，支持 EtherCAT DC（分布式时钟同步精度 <100 ns） |
| CAN 接口      | 3 路 CAN（支持 FDCAN，≤5 Mbps），兼容 MIT 协议、CANOpen 协议    |
| RS 485 接口   | 支持 Modbus RTU 协议和其他串口设备                           |

- EtherCAT 接收指令 → MCU 解码并通过 CAN 收发器转发至目标节点
- 整个过程需同步触发，无乱序、中断或数据延迟

***2. 软件架构***

| 功能模块 | 描述 |
|----------|------|
| 1. 同步控制模块 | 通过 **EtherCAT DC** 功能，实现对 CAN 节点的周期控制（触发发送） |
| 2. 数据缓存传输 | 使用 DMA 和双缓冲结构，实现 EtherCAT→CAN 数据交换 |
| 3. 协议栈 | 支持标准 CANOpen / 自定义 MIT 协议；与 EtherCAT 对象字典映射兼容 |

***3. 协议栈***

**EtherCAT 转 CAN：**
- 实现方式是将 EtherCAT 的 PDO/SDO 区映射为 CAN 的目标控制/状态寄存器格式
- 支持 FDCAN / CANOpen 两种主流格式
- 可兼容软硬件自研电机驱动板

**EtherCAT 转 Modbus RTU：**
- 将 EtherCAT 通信对象映射为 MODBUS 寄存器组
- 用于控制手部、电源管理模块等使用 RTU 协议的设备

这使得 EtherCAT 主站**可以统一调度底层的异构设备**，维护整体的数据一致性与时序同步。
