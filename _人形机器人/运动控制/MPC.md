

设计双足六自由度人形机器人的 MPC 运动控制方案，可以借鉴 MIT Cheetah 3 的运动控制思路，但需要针对双足系统的特点进行调整。

***MPC 任务***：
已知当前的系统状态和未来的参考系统状态，求解最优的系统控制输入（地面反作用力，足底接触力）。

***MPC 大致流程***：
1. 对机器人进行动力学微分建模
2. 对微分模型进行约化，使其满足特定形式（凸性）
3. 对微分模型进行离散化，得到预测模型
4. 通过 QP 最优化问题，得到足底接触力



***MPC问题建模：***


>[! NOTE]
>- **输入 $x_0$**：定义问题实例的**固定条件**，不可优化。MPC 在每个控制周期 k 开始时，会重新测量或估计当前状态作为新的 $x_0$，再求解新的优化问题 $P(x_0)$。
>- **决策变量 z**：通过调整 z 使目标函数 f (z) 最优，z 是算法的操作对象。
>- **目标函数形式**：f (z) 隐含 $x_0$ 的影响，但书写时省略 $x_0$ 以凸显 z 的优化本质。



# 问题建模

一个优化问题可被定义为$P(x_0)$ , 其中$x_0$ 表示优化问题的输入，注意不是**决策变量**。例如，一般 MPC 问题中，我们需要求解一个和当前状态 x 有关的优化问题，这个优化问题具有一定形式，先给定优化问题的形式，再给定 x 后优化问题就被完全定义了，因此说这个 x 是优化问题的输入。在 MPC 问题中，待定输入和后续状态才是决策变量。记决策变量为 z

优化问题的目标函数为$f(z)$ 。优化问题的目标函数一定和决策变量有关，有可能和 $x_0$ 有关。但是，$x_0$实际上已经被确定而不会变动，我们仅能通过修改决策变量，使得目标函数取得最优值，因此这里目标函数的输入一般仅写为 $z$ 而没有 $x_0$

MPC 优化问题的三部分划分具有普适性：

| **部分**      | **角色**    | **关键特性**         |
| ----------- | --------- | ---------------- |
| 输入 $x_0$    | 问题定义的参数   | 单次优化中固定，滚动更新     |
| 决策变量 $z$    | 待求解的操作对象  | 包含控制序列与预测状态，p≥m  |
| 目标函数 $f(z)$ | 性能评价的数学表达 | 隐含 x0 依赖，多目标权重可调 |
### 输入
- 功能：定义优化问题的**固定前提条件**，为问题提供上下文和初始状态, 不可优化。
- 作用
    - **参数化问题实例**：输入包括当前系统状态 $x_0$、参考轨迹、约束边界等外部给定参数。这些参数在单次优化中视为**常量**，不可调整。
    - **影响目标函数与约束**：输入决定了目标函数的具体形式（如跟踪误差依赖于当前状态$x_0$）和约束可行域（如动力学方程中的初始状态）。
    - **动态更新机制**：在滚动优化中，输入 $x_0$ 随时间步更新（如机器人运动时重新测量状态），使优化问题适应系统变化。例如在每个控制周期 k 开始时，会重新测量或估计当前状态作为新的，再求解新的优化问题。


### 决策变量

功能：代表待优化的**未知量**，通过调整其取值使目标函数最优。
作用：
- **控制和预测的耦合载体**：在模型预测控制（MPC）中，决策变量 𝑧 的构成定义为 控制序列与预测状态的组合，即控制序列预测状态序列 $z =[ 控制序列 , 预测状态序列 ]^T$。这一设计是 MPC 滚动优化框架的核心，
- **优化求解的核心对象**：算法***通过调整 z 满足约束并最小化目标函数***，如求解最优控制力序列以跟踪轨迹。
- **时域设计差异**：控制时域 m（优化步数）通常小于预测时域 p（状态预测步数），以平衡计算复杂度与长期性能。

>例如在机器人运动控制中，将两者综合，优化的目标位跟踪步态参考轨迹，同时最小化能耗。

***1. 控制序列（Control Sequence）***
- 定义：未来 𝑚 个时间步的控制输入向量，记为 
$$𝑈_𝑘 = [ 𝑢 ( 𝑘 | 𝑘 ) , 𝑢 ( 𝑘 + 1 | 𝑘 ) , … , 𝑢 ( 𝑘 + 𝑚 − 1 | 𝑘 ) ]^𝑇 $$
- 作用： **直接优化控制效率与平滑性**
	- 直接作用于系统，驱动状态变化（如机器人的关节力矩）
	- 通过优化调整以实现目标跟踪和约束满足。

***2.预测状态序列（Predicted State Sequence）***
- 定义：基于当前状态 $𝑥_0$ 和控制序列预测的未来 𝑝 步状态向量，记为 
$$𝑋_𝑘 = [ 𝑥 ( 𝑘 + 1 | 𝑘 ) , 𝑥 ( 𝑘 + 2 | 𝑘 ) , … , 𝑥 ( 𝑘 + 𝑝 | 𝑘 ) ]^𝑇 $$
- 作用： **保证长期跟踪性能与安全性**
	- 描述系统动态演化（如质心轨迹）
	- 作为优化目标（跟踪参考轨迹）和约束（状态边界）的载体。


>[! NOTE]
> 
> - **控制时域**：指优化问题中待求解的 **未来控制输入序列的长度**，即决策变量中控制输入部分的时间步数。
> - **预测时域**：指系统状态被预测的 **未来时间步数**，即状态预测序列的长度。
> - 𝑝 ≥ 𝑚 （预测时域 ≥ 控制时域）：
> 	- 较短的 m 可减少优化问题的决策变量数量，降低实时求解复杂度。
> 	- 较长的 p 能更全面地评估未来状态轨迹，避免短视决策



### 目标函数

- **功能**：量化决策变量 z 的**性能优劣**，引导优化方向。
- **作用**：
    - **多目标权衡工具**：目标函数整合多个冲突目标（如跟踪精度、控制平滑性、能耗），通过权重矩阵（Q,R）实现**帕累托最**优。
    - **隐含输入依赖**：虽写作$f(z)$，但实际依赖输入 $x_0$（如参考轨迹基于 $x_0$ 生成），数学表达中省略 $x_0$ 以凸显 z 的可优化性。
    - **结构设计**：通常包含运行成本（如状态跟踪误差 $‖x−xref‖_Q^2$）和终端成本（保证预测结束时的稳定性）

> **示例**：机器人控制的目标函数可能包含关节角度误差的平方和（运行成本）与终端姿态偏差惩罚（终端成本）。

# MPC 实现轨迹优化

人形机器人使用**质心动力学（Centroidal Dynamics）** 进行轨迹规划，是当前高性能运动控制的主流方法之一。使用质心动力学的轨迹规划，本质上是在给定任务目标（例如：走路、跳跃、上下楼梯）下，优化**质心（CoM）轨迹**和**支撑力（接触力）轨迹**，使系统满足动力学约束并可由机器人实现。

---

## 一、建模基础

### 1. 机器人模型与假设

1. **机器人模型与假设**
- 将机器人视作单刚体，质量 $m$ 集中于质心 $c(t)\in\mathbb R^3$。
- 有 $n$ 个潜在接触点（双足时 $n=2$），位置 $p_i(t)\in\mathbb R^3$。
- 重力向量 $g=[0,0,-9.81]^\top$。
- 可选假设：总角动量 $L(t)\approx 0$（零角动量假设，ZMP 模型）。


### 2. 质心动力学连续模型

1. **动量方程（质心线性加速度）：**
$$m\ddot{c}(t) = \sum_i f_i(t) + mg$$
- 表示机器人质心的受力平衡；
- 所有接触点的反作用力 + 重力 = 质心加速度乘以质量。

1. **角动量方程（绕质心的角动量变化）：**
$$\dot{L}(t) = \sum_i (p_i(t) - c(t)) \times f_i(t)$$
- 描述的是相对于质心的合力矩；
- 可选简化假设为 $\dot{L} = 0$（零角动量轨迹，ZMP 模型）。

| 变量                        | 含义                                  |
| ------------------------- | ----------------------------------- |
| $c(t)$                    | 质心位置，$\in \mathbb{R}^3$             |
| $\dot{c}(t), \ddot{c}(t)$ | 质心速度、加速度                            |
| $L(t)$                    | 绕质心的总角动量                            |
| $\dot{L}(t)$              | 角动量变化率                              |
| $f_i(t)$                  | 第 $i$ 个接触点的力（$i = 1, ..., n$）       |
| $p_i(t)$                  | 第 $i$ 个接触点的位置                       |
| $m$                       | 机器人总质量                              |
| $g$                       | 重力加速度向量（如 $g = [0, 0, -9.81]^\top$） |

### 3. 离散化动力学

取步长 $\Delta t$，时刻索引 $k=0,1,\dots,N$：

1. 加速度 → 速度
$$\dot c_{k+1} = \dot c_k + \ddot c_k\,\Delta t$$
2. 速度 → 位置
$$c_{k+1} = c_k + \dot c_k\,\Delta t + \tfrac 12\,\ddot c_k\,\Delta t^2$$
3. 质心加速度由接触力给出
$$\ddot c_k = \frac{1}{m}\Bigl (\sum_{i=1}^n f_{i, k} + m\, g\Bigr)$$
4. （可选）角动量积分
$$L_{k+1} = L_k + \Bigl (\sum_i (p_{i, k}-c_k)\times f_{i, k}\Bigr)\,\Delta t$$

### 4. 足端接触时序与步态规划

1. **步态周期划分**
    - 预先生成一段长度 $N$ 的接触激活序列  
$$a_{i,k} \in \{0,1\},\quad k=0\ldots N-1;\;$$
    - 同时得到对应的足端位置 $p_{i,k}$（可来自地形/步态规划器）。
2. **输入变量**
    - 当前状态：$x_0=[c_0,\dot c_0]$
    - 接触序列：${a_{i,k}}$，足端位置：${p_{i,k}}$
    - 机器人参数：$m,g$，摩擦系数 $\mu$，支撑面几何。

## 二、优化问题构建
### 1. 输入变量

**MPC 优化器每个控制周期从外部传入的已知量**，不参与求解。

|变量|含义|
|---|---|
|$c_0$、$\dot{c}_0$|当前质心状态（起点）|
|$p_{i,k}$|每个足部的接触位置（来自步态规划器）|
|接触激活指示 $a_{i,k} \in {0, 1}$|哪个时间点哪只脚着地|
|机器人质量 $m$、重力 $g$|常数|
|地面高度或摩擦系数|用于约束接触力|

### 2. 状态变量

- $c(t)$：质心位置（通常为 $c \in \mathbb{R}^3$）
- $\dot{c}(t)$：质心速度
- $L(t)$：机器人总角动量（常用角动量约为零）

第一个状态 $x_0 = [c_0, \dot{c}_0]$ 是输入。
### 3. 控制变量
- $f_i(t)$：每个接触点的力（第 $i$ 个足底）
- $p_i(t)$：第 $i$ 个接触点位置（预设或规划）
- $\tau_i(t)$：接触点的摩擦锥约束中的力矩（可选）


---
## 二、优化问题构建

### 6.1 决策变量

$$\Bigl\{c_k,\;\dot c_k,\;\{f_{i, k}\}_{i=1}^n\Bigr\}_{k=1}^N$$
- 初始状态 $c_0,\dot c_0$ 为已知 **输入**。

### 6.2 目标函数（示例）

- **最小化接触力能量**
    
    J 1=∑k=0 N−1∑i=1 n∥fi, k∥2 J_1 = \sum_{k=0}^{N-1}\sum_{i=1}^n\|f_{i, k}\|^2
- **平滑质心轨迹**（加速度或 jerk）
    
    J 2=∑k=1 N−1∥c¨k−c¨k−1∥2 J_2 = \sum_{k=1}^{N-1}\|\ddot c_k - \ddot c_{k-1}\|^2
- **跟踪目标位置/速度**
    
    J 3=∑k=1 N (∥ck−ckref∥2+∥c˙k−c˙kref∥2) J_3 = \sum_{k=1}^N \Bigl (\|c_k - c_k^\mathrm{ref}\|^2 + \|\dot c_k - \dot c_k^\mathrm{ref}\|^2\Bigr)

总目标：J=w 1 J 1+w 2 J 2+w 3 J 3 J = w_1 J_1 + w_2 J_2 + w_3 J_3

### 6.3 约束条件

1. **动力学约束**（离散化形式 as 上节）
    
2. **初始条件**
    
    C 0=c^0,  c˙0=c˙^0 c_0=\hat c_0,\;\dot c_0=\hat{\dot c}_0
3. **接触力激活**
    
    Fi, k=0 if ai, k=0 f_{i, k}=0\quad\text{if }a_{i, k}=0
4. **摩擦锥（线性化）**
    
    ∥[fi, k]x, y∥≤μ fi, kz, fi, kz≥0\|[f_{i, k}]_{x, y}\|\le\mu\, f_{i, k}^z,\quad f_{i, k}^z\ge 0
5. **支撑多面体**（保持 ZMP 在足面内，可选）
    
6. **终端约束**（如 $c_N=c_\mathrm{goal}$，$\dot c_N=0$）
    

## 二、 足端接触时序与步态规划

1. **步态周期划分**
    - 预先生成一段长度 $N$ 的接触激活序列  
    $$A_{i, k} \in \{0,1\},\quad k=0\ldots N-1;\; i=1\ldots n$$
    - 同时得到对应的足端位置 $p_{i,k}$（可来自地形/步态规划器）。
        
2. **输入变量**
    - 当前状态：$_0=[c_0,\dot c_0]$
    - 接触序列：${a_{i,k}}$，足端位置：${p_{i,k}}$
    - 机器人参数：$m,g$，摩擦系数 $\mu$，支撑面几何。



## 二、轨迹规划问题表述

可以将质心轨迹规划转化为一个 **非线性/凸优化问题**（通常为 Quadratic Program 或 Nonlinear Program）：

### 优化变量
- $c(t), \dot{c}(t), \ddot{c}(t)$：质心轨迹
- $f_i(t)$：接触力
- $p_i(t)$：接触位置（可设定为已知）

### 优化目标（典型）

- 最小化接触力变化：$\sum |f_i(t)|^2$
- 最小化质心加速度或 jerk
- 跟踪期望质心轨迹

### 约束：

- 动量守恒方程（质心动力学）
- 接触力 $\in$ 摩擦锥（可近似为线性锥）
- $f_i(t) = 0$ 当足部未接触
- 保证质心在可行支撑区域上方（防止跌倒）



## 动力学建模

### 单刚体模型（SRBD）
- **质心动力学**：将人形机器人视为一个刚体集中在质心，具备质量$m$和转动惯量$\mathbf{I}$。

- **动力学方程**：
  - 线性动力学：
$$
M \dot{\mathbf{v}} = \mathbf{f}_\text{left} + \mathbf{f}_\text{right} + m \mathbf{g}
$$
  - 角动力学：
$$
    \mathbf{I} \dot{\boldsymbol{\omega}} + \boldsymbol{\omega} \times \mathbf{I} \boldsymbol{\omega} = \mathbf{r}_\text{left} \times \mathbf{f}_\text{left} + \mathbf{r}_\text{right} \times \mathbf{f}_\text{right}
   $$

### 双足力优化
- **摩擦锥约束**：脚与地面接触力满足摩擦锥条件。
- **步态转移**：基于步态周期在双/单腿支撑状态间转换。

## 步态规划

### 步态生成
- **步态模式**：如行走、跑步、站立，确定每只脚的接触状态。
- **步态周期**：定义并调节步态周期，以适应不同地形和速度。

### 支撑状态
- **双腿支撑**：考虑双腿同时接触地面时的稳定性。
- **单腿支撑**：在单腿支撑相位中保持动态平衡。

## 状态预测与约束

### 模型预测控制（MPC）
- **优化目标**：
  - 最小化轨迹偏差，保证质心位置、速度和平衡的期望满足性。
  - 保持动态平衡时，减少脚部的滑动和不稳定性。

- **约束条件**：
  - 地面反作用力需满足摩擦和力矩约束。
  - 支持腿的施力位置约束。
  - 确保足够的步伐边缘稳定性。

## 数值求解

- **QP 求解**：使用快速优化工具（如 QP 求解器）解决 MPC 优化问题。
- **实时性保障**：以高频率（如 1 kHz）更新控制输入，给出实时控制力。

## 输出指导与反馈

- **关节控制**：将优化得到的足端力转换为关节空间的力矩控制。
- **反馈校正**：利用 IMU 传感器和足压传感器，校正姿态偏差。

## 环境适应

- **适应性调整**：
  - 针对不同地形（如楼梯、斜坡）带来的挑战，通过步态周期和支撑状态的调整提高适应能力。
  - 结合视觉传感器信息，让机器人预判环境变化。

## 总结

通过将 MIT Cheetah 3 的四足控制策略扩展应用到六自由度双足机器人上，仔细考量双足平衡问题以及步态转换带来的动态稳定性挑战，设计出一套适用于人形机器人的 MPC 运动控制方案。这种方法既保持了 MIT 方案的计算效率，又针对人形机器人的复杂性进行了必要的增强，有助于实现更为灵活和智能的运动控制。



下面给出一个基于**质心动力学（Centroidal Dynamics）**的人形机器人轨迹规划的完整实现思路。该流程可分为以下几个主要阶段，每个阶段均给出核心公式。

---

## 1. 系统概览与流程图

1. **机器人模型与假设**
    
2. **足端接触时序与步态规划**
    
3. **质心动力学建模**
    
4. **离散化动力学方程**
    
5. **优化问题构建（决策变量、目标函数、约束）**
    
6. **求解器集成（QP/NLP or MPC）**
    
7. **整合到全身控制器**
    

```mermaid
flowchart LR
  A[模型与假设] --> B[接触/步态规划]
  B --> C[质心动力学建模]
  C --> D[离散化系统]
  D --> E[优化问题构建]
  E --> F[求解器求解]
  F --> G[全身控制映射]
```

---

## 2. 机器人模型与假设

- 将机器人视作单刚体，质量 $m$ 集中于质心 $c(t)\in\mathbb R^3$。
    
- 有 $n$ 个潜在接触点（双足时 $n=2$），位置 $p_i(t)\in\mathbb R^3$。
    
- 重力向量 $g=[0,0,-9.81]^\top$。
    
- 可选假设：总角动量 $L(t)\approx 0$（零角动量假设，ZMP 模型）。
    

---

## 3. 足端接触时序与步态规划

1. **步态周期划分**
    
    - 预先生成一段长度 $N$ 的接触激活序列  
        ai,k∈{0,1},k=0…N−1;  i=1…na_{i,k} \in \{0,1\},\quad k=0\ldots N-1;\; i=1\ldots n
        
    - 同时得到对应的足端位置 $p_{i,k}$（可来自地形/步态规划器）。
        
2. **输入变量**
    
    - 当前状态：x0=[c0,c˙0]x_0=[c_0,\dot c_0]
        
    - 接触序列：${a_{i,k}}$，足端位置：${p_{i,k}}$
        
    - 机器人参数：$m,g$，摩擦系数 $\mu$，支撑面几何。
        

---

## 4. 质心动力学连续模型

### 4.1 线动量守恒

m c¨(t)  =  ∑i=1nfi(t)  +  m gm\,\ddot c(t)\;=\;\sum_{i=1}^n f_i(t)\;+\;m\,g

- $f_i\in\mathbb R^3$：第 $i$ 个接触力。
    

### 4.2 角动量守恒

L˙(t)  =  ∑i=1n (pi(t)−c(t))×fi(t)\dot L(t)\;=\;\sum_{i=1}^n\,(p_i(t)-c(t))\times f_i(t)

- 若采用 **零角动量简化**，可令 $\dot L(t)=0$。
    

---

## 5. 离散化动力学（用于MPC）

取步长 $\Delta t$，时刻索引 $k=0,1,\dots,N$：

1. **加速度 → 速度**
    
    c˙k+1=c˙k+c¨k Δt\dot c_{k+1} = \dot c_k + \ddot c_k\,\Delta t
2. **速度 → 位置**
    
    ck+1=ck+c˙k Δt+12 c¨k Δt2c_{k+1} = c_k + \dot c_k\,\Delta t + \tfrac12\,\ddot c_k\,\Delta t^2
3. **质心加速度由接触力给出**
    
    c¨k=1m(∑i=1nfi,k+m g)\ddot c_k = \frac{1}{m}\Bigl(\sum_{i=1}^n f_{i,k} + m\,g\Bigr)
4. （可选）**角动量积分**
    
    Lk+1=Lk+(∑i(pi,k−ck)×fi,k) ΔtL_{k+1} = L_k + \Bigl(\sum_i (p_{i,k}-c_k)\times f_{i,k}\Bigr)\,\Delta t

---

## 6. 优化问题构建

### 6.1 决策变量

{ck,  c˙k,  {fi,k}i=1n}k=1N\Bigl\{c_k,\;\dot c_k,\;\{f_{i,k}\}_{i=1}^n\Bigr\}_{k=1}^N

- 初始状态 $c_0,\dot c_0$ 为已知 **输入**。
    

### 6.2 目标函数（示例）

- **最小化接触力能量**
    
    J1=∑k=0N−1∑i=1n∥fi,k∥2 J_1 = \sum_{k=0}^{N-1}\sum_{i=1}^n\|f_{i,k}\|^2
- **平滑质心轨迹**（加速度或 jerk）
    
    J2=∑k=1N−1∥c¨k−c¨k−1∥2 J_2 = \sum_{k=1}^{N-1}\|\ddot c_k - \ddot c_{k-1}\|^2
- **跟踪目标位置/速度**
    
    J3=∑k=1N(∥ck−ckref∥2+∥c˙k−c˙kref∥2) J_3 = \sum_{k=1}^N \Bigl(\|c_k - c_k^\mathrm{ref}\|^2 + \|\dot c_k - \dot c_k^\mathrm{ref}\|^2\Bigr)

总目标：J=w1J1+w2J2+w3J3J = w_1J_1 + w_2J_2 + w_3J_3

### 6.3 约束条件

1. **动力学约束**（离散化形式 as 上节）
    
2. **初始条件**
    
    c0=c^0,  c˙0=c˙^0c_0=\hat c_0,\;\dot c_0=\hat{\dot c}_0
3. **接触力激活**
    
    fi,k=0if ai,k=0f_{i,k}=0\quad\text{if }a_{i,k}=0
4. **摩擦锥（线性化）**
    
    ∥[fi,k]x,y∥≤μ fi,kz,fi,kz≥0\|[f_{i,k}]_{x,y}\|\le\mu\,f_{i,k}^z,\quad f_{i,k}^z\ge 0
5. **支撑多面体**（保持ZMP在足面内，可选）
    
6. **终端约束**（如 $c_N=c_\mathrm{goal}$，$\dot c_N=0$）
    

---

## 7. 求解器与实时MPC

1. **QP 方案**
    
    - 若只含二次目标与线性约束，可调用 OSQP/qpOASES。
        
2. **NLP 方案**
    
    - 若含非线性摩擦锥、角动量，可用 IPOPT/CasADi。
        
3. **滚动优化（MPC）**
    
    - 每周期获取最新 $[c_0,\dot c_0]$，滚动窗口求解，输出 $f_{i,0}$ 并前移一步。
        

---

## 8. 全身控制映射

将得到的 **质心加速度** 或 **接触力** 转换为关节层面命令，常见方法：

1. **逆动力学 QP**
    
    min⁡q¨  ∥x¨CoM−JCoM q¨∥2+λ∥τ∥2\min_{\ddot q}\;\|\ddot x_\text{CoM} - J_\text{CoM}\,\ddot q\|^2 + \lambda\|\tau\|^2
2. **层次式控制**
    
    - 优先保证质心轨迹与支撑力，再考虑姿态和手臂任务。
        

---

## 9. 实现建议

- **工具链**：CasADi／Pinocchio／OSQP／qpOASES／IPOPT。
    
- **数值稳定**：选取合适的 $\Delta t$（如 0.01s）与正则化权重。
    
- **调参**：权重 $w_i$、摩擦系数 $\mu$、窗口长度 $N$ 对性能影响大。
    
- **预热优化**：可先离线生成参考轨迹，再在线微调。
    

---

以上即是基于质心动力学的人形机器人轨迹规划全流程与对应公式。你可据此搭建自己的 MPC 仿真与实机控制框架，若需示例代码（CasADi 模板／逆动力学 QP）也可进一步请求。祝实验顺利！