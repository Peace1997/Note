

设计双足六自由度人形机器人的 MPC 运动控制方案，可以借鉴 MIT Cheetah 3 的运动控制思路，但需要针对双足系统的特点进行调整。

***MPC 任务***：
已知当前的系统状态和未来的参考系统状态，求解最优的系统控制输入（地面反作用力，足底接触力）。

***MPC 大致流程***：
1. 对机器人进行动力学微分建模
2. 对微分模型进行约化，使其满足特定形式（凸性）
3. 对微分模型进行离散化，得到预测模型
4. 通过 QP 最优化问题，得到足底接触力



***MPC问题建模：***


>[! NOTE]
>- **输入 $x_0$**：定义问题实例的**固定条件**，不可优化。MPC 在每个控制周期 k 开始时，会重新测量或估计当前状态作为新的 $x_0$，再求解新的优化问题 $P(x_0)$。
>- **决策变量 z**：通过调整 z 使目标函数 f (z) 最优，z 是算法的操作对象。
>- **目标函数形式**：f (z) 隐含 $x_0$ 的影响，但书写时省略 $x_0$ 以凸显 z 的优化本质。



## 问题建模

一个优化问题可被定义为$P(x_0)$ , 其中$x_0$ 表示优化问题的输入，注意不是**决策变量**。例如，一般 MPC 问题中，我们需要求解一个和当前状态 x 有关的优化问题，这个优化问题具有一定形式，先给定优化问题的形式，再给定 x 后优化问题就被完全定义了，因此说这个 x 是优化问题的输入。在 MPC 问题中，待定输入和后续状态才是决策变量。记决策变量为 z

优化问题的目标函数为$f(z)$ 。优化问题的目标函数一定和决策变量有关，有可能和 $x_0$ 有关。但是，$x_0$实际上已经被确定而不会变动，我们仅能通过修改决策变量，使得目标函数取得最优值，因此这里目标函数的输入一般仅写为 $z$ 而没有 $x_0$

MPC 优化问题的三部分划分具有普适性：

| **部分**      | **角色**    | **关键特性**         |
| ----------- | --------- | ---------------- |
| 输入 $x_0$    | 问题定义的参数   | 单次优化中固定，滚动更新     |
| 决策变量 $z$    | 待求解的操作对象  | 包含控制序列与预测状态，p≥m  |
| 目标函数 $f(z)$ | 性能评价的数学表达 | 隐含 x0 依赖，多目标权重可调 |
### 输入
- 功能：定义优化问题的**固定前提条件**，为问题提供上下文和初始状态, 不可优化。
- 作用
    - **参数化问题实例**：输入包括当前系统状态 $x_0$、参考轨迹、约束边界等外部给定参数。这些参数在单次优化中视为**常量**，不可调整。
    - **影响目标函数与约束**：输入决定了目标函数的具体形式（如跟踪误差依赖于当前状态$x_0$）和约束可行域（如动力学方程中的初始状态）。
    - **动态更新机制**：在滚动优化中，输入 $x_0$ 随时间步更新（如机器人运动时重新测量状态），使优化问题适应系统变化。例如在每个控制周期 k 开始时，会重新测量或估计当前状态作为新的，再求解新的优化问题。


### 决策变量

功能：代表待优化的**未知量**，通过调整其取值使目标函数最优。
作用：
- **控制和预测的耦合载体**：在模型预测控制（MPC）中，决策变量 𝑧 的构成定义为 控制序列与预测状态的组合，即控制序列预测状态序列 $z =[ 控制序列 , 预测状态序列 ]^T$。这一设计是 MPC 滚动优化框架的核心，
- **优化求解的核心对象**：算法***通过调整 z 满足约束并最小化目标函数***，如求解最优控制力序列以跟踪轨迹。
- **时域设计差异**：控制时域 m（优化步数）通常小于预测时域 p（状态预测步数），以平衡计算复杂度与长期性能。

>例如在机器人运动控制中，将两者综合，优化的目标位跟踪步态参考轨迹，同时最小化能耗。

***1. 控制序列（Control Sequence）***
- 定义：未来 𝑚 个时间步的控制输入向量，记为 
$$𝑈_𝑘 = [ 𝑢 ( 𝑘 | 𝑘 ) , 𝑢 ( 𝑘 + 1 | 𝑘 ) , … , 𝑢 ( 𝑘 + 𝑚 − 1 | 𝑘 ) ]^𝑇 $$
- 作用： **直接优化控制效率与平滑性**
	- 直接作用于系统，驱动状态变化（如机器人的关节力矩）
	- 通过优化调整以实现目标跟踪和约束满足。

***2.预测状态序列（Predicted State Sequence）***
- 定义：基于当前状态 $𝑥_0$ 和控制序列预测的未来 𝑝 步状态向量，记为 
$$𝑋_𝑘 = [ 𝑥 ( 𝑘 + 1 | 𝑘 ) , 𝑥 ( 𝑘 + 2 | 𝑘 ) , … , 𝑥 ( 𝑘 + 𝑝 | 𝑘 ) ]^𝑇 $$
- 作用： **保证长期跟踪性能与安全性**
	- 描述系统动态演化（如质心轨迹）
	- 作为优化目标（跟踪参考轨迹）和约束（状态边界）的载体。


>[! NOTE]
> 
> - **控制时域**：指优化问题中待求解的 **未来控制输入序列的长度**，即决策变量中控制输入部分的时间步数。
> - **预测时域**：指系统状态被预测的 **未来时间步数**，即状态预测序列的长度。
> - 𝑝 ≥ 𝑚 （预测时域 ≥ 控制时域）：
> 	- 较短的 m 可减少优化问题的决策变量数量，降低实时求解复杂度。
> 	- 较长的 p 能更全面地评估未来状态轨迹，避免短视决策



### 目标函数

- **功能**：量化决策变量 z 的**性能优劣**，引导优化方向。
- **作用**：
    - **多目标权衡工具**：目标函数整合多个冲突目标（如跟踪精度、控制平滑性、能耗），通过权重矩阵（Q,R）实现**帕累托最**优。
    - **隐含输入依赖**：虽写作$f(z)$，但实际依赖输入 $x_0$（如参考轨迹基于 $x_0$ 生成），数学表达中省略 $x_0$ 以凸显 z 的可优化性。
    - **结构设计**：通常包含运行成本（如状态跟踪误差 $‖x−xref‖_Q^2$）和终端成本（保证预测结束时的稳定性）

> **示例**：机器人控制的目标函数可能包含关节角度误差的平方和（运行成本）与终端姿态偏差惩罚（终端成本）。



## 动力学建模

### 单刚体模型（SRBD）
- **质心动力学**：将人形机器人视为一个刚体集中在质心，具备质量$m$和转动惯量$\mathbf{I}$。

- **动力学方程**：
  - 线性动力学：
$$
M \dot{\mathbf{v}} = \mathbf{f}_\text{left} + \mathbf{f}_\text{right} + m \mathbf{g}
$$
  - 角动力学：
$$
    \mathbf{I} \dot{\boldsymbol{\omega}} + \boldsymbol{\omega} \times \mathbf{I} \boldsymbol{\omega} = \mathbf{r}_\text{left} \times \mathbf{f}_\text{left} + \mathbf{r}_\text{right} \times \mathbf{f}_\text{right}
   $$

### 双足力优化
- **摩擦锥约束**：脚与地面接触力满足摩擦锥条件。
- **步态转移**：基于步态周期在双/单腿支撑状态间转换。

## 步态规划

### 步态生成
- **步态模式**：如行走、跑步、站立，确定每只脚的接触状态。
- **步态周期**：定义并调节步态周期，以适应不同地形和速度。

### 支撑状态
- **双腿支撑**：考虑双腿同时接触地面时的稳定性。
- **单腿支撑**：在单腿支撑相位中保持动态平衡。

## 状态预测与约束

### 模型预测控制（MPC）
- **优化目标**：
  - 最小化轨迹偏差，保证质心位置、速度和平衡的期望满足性。
  - 保持动态平衡时，减少脚部的滑动和不稳定性。

- **约束条件**：
  - 地面反作用力需满足摩擦和力矩约束。
  - 支持腿的施力位置约束。
  - 确保足够的步伐边缘稳定性。

## 数值求解

- **QP 求解**：使用快速优化工具（如 QP 求解器）解决 MPC 优化问题。
- **实时性保障**：以高频率（如 1 kHz）更新控制输入，给出实时控制力。

## 输出指导与反馈

- **关节控制**：将优化得到的足端力转换为关节空间的力矩控制。
- **反馈校正**：利用 IMU 传感器和足压传感器，校正姿态偏差。

## 环境适应

- **适应性调整**：
  - 针对不同地形（如楼梯、斜坡）带来的挑战，通过步态周期和支撑状态的调整提高适应能力。
  - 结合视觉传感器信息，让机器人预判环境变化。

## 总结

通过将 MIT Cheetah 3 的四足控制策略扩展应用到六自由度双足机器人上，仔细考量双足平衡问题以及步态转换带来的动态稳定性挑战，设计出一套适用于人形机器人的 MPC 运动控制方案。这种方法既保持了 MIT 方案的计算效率，又针对人形机器人的复杂性进行了必要的增强，有助于实现更为灵活和智能的运动控制。