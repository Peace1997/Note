
## 机器人超参数设置

域随机化的超参数主要包括三类：
- 机器人本体建模的随机化
- 通信延迟的随机化
- 外部扰动的随机化

### 机器人质心（com_displacement）`
 `com_offset_x` &  `com_offset_y`

质心位置变化会改变零力矩点(ZMP)分布，人在行走时躯干 COM 横向摆动幅度约±5cm，，范围±6cm 可以对应典型重心偏移场景。由于机器人结构本身会与 URDF 会有些许出入，因此不同机器人的质心会有些许差异，需要进行微调。


**前后质心**：初次训练时，暂时不设置质心的偏移，根据机器人站立时机器人机身偏前和偏后的状态，在 Sim2Sim 仿真环境（例如 Mujoco）调节机器人的质心去复现这样的姿态。例如，真机机器人质心偏前时，可以在训练时将质心往前调。
`常用范围：[-0.1, 0.1]`

**左右质心**：同前后质心一样，根据训练的结果，在 Sim2Sim 环境中设定固定的直线速度，观察机器人左右偏移情况，如果真机和 Sim2Sim 的表现是一致的，则说明左右质心没有明显偏移。例如，仿真中直行，真机中向左偏，则训练时将质心设置为左偏。
`常用范围：[0，0.03]`

```
L12的URDF文件质心默认偏移了[0.08]

L12-01 训练时质心训练偏移：
x: [0.04,0.08]  --因为默认偏移- > [-0.04,0.0]
y: 0.018

L12-02 训练时质心偏移
用同一套模型，在L12-02表现是偏后，所以02质心较01质心仍然偏后。

y: 0.012

```

### 地面摩擦系数（friction）

摩擦系数覆盖从冰面(μ≈0.1)到橡胶地面(μ≈1.5)的极端情况。上限2.0模拟特殊防滑涂层。

`常用范围：[0.1，2]`
### 机身负载 （payload_mass）

负载质量直接影响系统总惯量矩阵，考虑到负载需求以及有无电池（5kg）的测试，范围\[-6.0,6.0\] kg 覆盖了典型附加负载（如携带物品或工具）

`常用范围：[-6，6]`
### 恢复系数（restitution）

恢复系数基本与地面弹性的正相关性成立，但受材料相态、表面形貌、温度等多因素调制。

**恢复系数定义**为碰撞后相对速度与碰撞前相对速度的比值：
$$
e = \frac{v_2' - v_1'}{v_1 - v_2}
$$

在时域上，该参数精确刻画了动能耗散过程：
- 当$e=1$时（理想弹性碰撞），系统动能守恒，满足：
$$
\frac{1}{2}m_1v_1^2 + \frac{1}{2}m_2v_2^2 = \frac{1}{2}m_1v_1'^2 + \frac{1}{2}m_2v_2'^2
$$
- 当$e=0$时（完全塑性碰撞），动能损失最大：
$$
\Delta KE = \frac{m_1m_2}{2(m_1+m_2)}(v_1-v_2)^2
$$

对于人形机器人，落地冲击时的能量耗散特性直接影响控制策略：
- 木质地板（e≈0.5）允许 10-15%动能通过形变回收
- 橡胶垫（e≈0.3）将 80%以上冲击能转化为热能
- 沙地（e≈0.1）实现 96%以上的能量吸收


恢复系数 $e$ 与材料弹性模量 $E$ 的定量关系可表示为：
$$
e \propto \sqrt{\frac{E}{\rho}} \times \frac{1}{\sqrt{\sigma_y}}
$$
其中 $\rho$ 为密度，$\sigma_y$ 为屈服强度。这显示弹性模量越高、屈服强度越低的材料，确实恢复系数越大。


| 材料类型   | 弹性模量 (GPa) | 典型恢复系数   | 能量耗散率  |
| ------ | ---------- | -------- | ------ |
| 橡胶（轮胎） | 0.01-0.1   | 0.3-0.4  | 60-70% |
| 硬木地板   | 10-15      | 0.5-0.6  | 30-40% |
| 钢板     | 200        | 0.7-0.8  | 10-15% |
| 气凝胶    | 0.001      | 0.05-0.1 | 90-95% |


**5. 特殊案例解析**
**现象**：湿滑冰面（低摩擦μ=0.1）却具有较高恢复系数（e=0.65）
**机理**：
- 低温使水膜结晶，材料进入玻璃态转变区（Tg≈-20℃）
- 弹性模量突增导致碰撞接触时间缩短至5ms
- 振动能量在声子传播中被耗散的比例降低

**控制对策**：
- 主动增加足底阻尼器行程（>8mm）
- 调整步态相位差 $\Delta\phi = \frac{\pi}{2}\sqrt{1-e}$
- 限制关节加速度 $\ddot{\theta}_{max} = 15(1-e)\ rad/s^2$


`常用范围：[0.0，0.5]` ，后面如何想在硬地面表现更好，会增加最高值至 0.8




### 电机强度参数（motor_strength）

电机强度参数代表驱动系统的参数性能，其核心参数包括电机峰值扭矩、减速比、传动效率及整体惯量负载。其数学表示为：
$$
S_m = \frac{\tau_{max} \cdot N \cdot \eta}{\sqrt{J_{rotor} + \frac{J_{load}}{N^2}}}
$$
其中：
- $\tau_{max}$：电机峰值扭矩（Nm）
- $N$：减速比
- $\eta$：传动效率
- $J_{rotor}$：电机转子惯量（kg·m²）
- $J_{load}$：负载惯量（kg·m²）

**谐波减速器 vs. 行星减速器**

| 参数维度    | 谐波减速器         | 行星减速器         |
| ------- | ------------- | ------------- |
| 典型减速比范围 | 50:1 ~ 160:1  | 3:1 ~ 10:1    |
| 效率（η）   | 80%-90%       | 90%-98%       |
| 回差      | <1 arcmin     | 3-10 arcmin   |
| 功率密度    | 0.8-1.2 kW/kg | 1.5-2.5 kW/kg |
| 轴向长度    | 0.8-1.2×直径    | 1.5-2×直径      |
`常用范围：[0.7,1.4]`

### 连杆质量（link_mass）
质量参数 20% 波动模拟制造公差和材料损耗。其中，铝合金连杆典型质量公差：±15%。


`常用范围：[0.8，1.2]`


### 电机偏移（motor_offset）
电机偏移可能会体现在以下几个方面：
- **位置偏移**: 目标关节或位置的实际值与指令值之间存在偏差。
- **输出力矩偏差**: 电机施加的力矩与指令力矩之间存在误差。
- **速度偏移**: 电机旋转的实际速度与设定值之间存在不一致。

在算法训练过程中，我们采用位置偏移，即把电机偏移$\Delta q$加在强化学习输出的动作之后，从而使计算的目标力矩增加或减少。
$$
    q_{\text{}}(t) = q_{\text{target}}(t) + \Delta q
$$


`常用范围：[-0.035,0.045]`

### 关节摩擦（joint_friction）

计算关节的摩擦力：
$$ f_{\text{joint}} = F_c \cdot \text{sign}(\dot{q}) + F_v \cdot \dot{q} + F_s \cdot h(|\dot{q}|, \epsilon) $$
将摩擦力作用在电机的力矩输出中：
$$ \tau_{\text{real}} = \tau_{\text{target}} - f_{\text{joint}} $$

其中，$f(q, \dot{q})$ 是关节摩擦的关键部分。摩擦力的建模一般包括以下三种类型：
1. **库仑摩擦（Coulomb Friction）**  
   一种速度无关的摩擦，大小为常值，方向与关节速度 $\dot{q}$ 相反： $$
   f_{\text{Coulomb}} = \text{sign}(\dot{q}) \cdot F_c
   $$其中，$F_c$ 是库仑摩擦系数，$\text{sign}(\dot{q})$ 表示速度的符号函数。

在实际应用过程中，通常利用 $\tanh$ 函数，处理关节速度的符号特性。当$\dot{q}$ 较小时， $\tanh$ 近似线性；当速度增大时， $\tanh$函数饱和于 1 或-1，从而使该项趋于一个固定值：
$$
 \text{Term}_1 = F_c \cdot \tanh\left(\frac{\dot{q}}{Q_s}\right)
 $$
     这样就可以模拟库仑摩擦的恒定摩擦力，保证在高速时不会无限增大。
 
1. **粘滞摩擦（Viscous Friction）**  
   与关节速度成正比的摩擦力：
   $$
   f_{\text{Viscous}} = F_v \cdot \dot{q}
   $$
   其中，$F_v$ 是粘滞摩擦系数。

 在实际应用过程中，直接按速度乘以系数 $F_v$，模拟粘滞摩擦力，即摩擦力线性随速度变化：
 $$
 \text{Term}_2 = F_v \cdot \dot{q}
 $$
 这部分在速度较大时同样会增加，但没有饱和效果。


2. **静摩擦（Static Friction）**  
   阻止关节启动的静态摩擦，在速度接近零时出现：
   $$
   f_{\text{Static}} = F_s \quad \text{if} \quad |\dot{q}| < \epsilon
   $$
   其中，$F_s$ 是静摩擦阈值，$\epsilon$ 是低速阈值。

综合起来，一个完整的摩擦模型可以表示为：
$$
f(q, \dot{q}) = F_c \cdot \text{sign}(\dot{q}) + F_v \cdot \dot{q} + F_s \cdot h(|\dot{q}|, \epsilon)
$$

其中，$h(|\dot{q}|, \epsilon)$ 是静摩擦的作用范围函数。

3. **摩擦随机化**
为了应对现实摩擦力的不确定性，可以在仿真中对摩擦参数进行随机化，增强控制策略的鲁棒性。随机化方法可以是：
- 均匀分布：$F_r \sim U(F_{\text{min}}, F_{\text{max}})$
- 正态分布：$F_r= \sim \mathcal{N}(\mu, \sigma)$
---- 

摩擦力会抵消部分力矩输出，导致关节实际输出不能完全响应控制指令。在启动、低速运动和停止时尤为显著。

例如：
$$
\tau_{\text{实际}} = \tau_{\text{target}} - (F_c + F_s) - F_v \cdot \dot{q}
$$

常用取值范围：
```Python
1-4 行星大关节
[0.03,0.08] -- 行星关节1-4

5-6 踝关节
行星关节
Star_Fc = 0.45
Star_Qs = 0.1
Star_Fv = 0.023 


谐波关节：
Left_Fc = 2.8
Left_Qs = 0.1
Left_Fv = 0.21
Right_Fc = 2.8
Right_Qs = 0.1
Right_Fv = 0.21

随机化摩擦系数：

```
`




### 转动惯量 （joint_armature）
遍历每个关节，并从各自的 armature 常用取值范围中均匀随机采样：

`常用取值范围： [0.008, 0.12]`

### 外部扰动（disturbance）
对机器人的三个方向随机生成扰动力，将力和力矩施加在刚体上，通常用于模拟外部扰动。

`常用取值范围： [-500, 500]`



### 随机推力（push_robots）
对机器人的基体线速度和角速度增加扰动，将随机化元素直接施加在机器人的基体状态中。外部扰动和随机推力都存在一定间隔。

`常用范围：push_vel_xy = [-0.3,0.3] push_ang_vel = [-0.4,0.4]


### 控制增益（kp_kd）

随机化比例控制增益和微分比例控制增益
`常用范围[0.8,1.2]`


### 动作延迟（action_delay）
模拟真实机器人中从控制指令产生到实际执行之间存在的延迟现象。实现的方式是增加一个**延迟动作队列**，在每步执行的时候，将当前动作存储到延迟队列中，并从队列中随机取出延迟时间对应的动作进行应用。

`常用范围：[5,30]`
具体延迟可根据实际情况进行调整
### 系统延迟 （sys_delay）

系统延迟包括，IMU 延迟和电机状态延迟。其中 IMU 影响基体状态信息，电机状态延迟影响关节位置和速度。

`常用范围：IMU [1,10]  电机状态延迟[1,5]`


### 上肢速度扰动（upperbody_speed）
对左右臂的关节速度设置扰动，当强化仅考虑控制下半身运动时，可以把上肢的运动作为扰动，这样强化站立状态就可以支持上半身播放动作或遥操作。

上肢运动的扰动通常可以读取一个固定的参考播放动作序列数据集，而增大或减小从数据集中取值的间隔可以影响上肢运动的速度，我们实现时可以考虑随机化一个间隔的范围，从而控制上半身运动的速度。

`常用范围：[0,12]`



## 机器人奖励函数
























- **摩擦系数** [[人形机器人本体#摩擦特性]]
	- 静摩擦
	- 动态摩擦

- **减速器建模：**
	- 谐波关节：谐波关节通常具有较高的减速比，机器人通常具有较高的扭矩，但是关节的实际转速通常会较低，谐波关节利用率，通常会进行参数辨识，对库伦摩擦力的相关参数进行建模，
	- 
- **KP、KD 设置**：
	1. 悬空正弦，看什么 kpkd 参数不会引起机器的震动
	2. 悬空正弦摸到一组大概的参数后，
- **延迟**
	- L 12 的上下行延迟：5 ms；电机响应延迟：5 ms
	- 如果仿真延迟大于真机延迟：机器人可能会“过度预测”或反应过快，导致多余或不必要的动作，出现“过调节”的现象，因为仿真时延较高的情况下，策略会有意地预测和适应延迟，而在实机中这种预测会导致多余的修正
	- 如果仿真延迟小于真机延迟：这种策略可能无法及时响应环境变化，强化学习算法获得的反馈也会滞后，导致反应不足或动作延迟，导致机器人动作与反馈无法匹配，从而导致策略性能下降，尤其是在动态环境或需要快速响应的任务中。
- **Sim 2 Real Gap**：根据真机的表现和数据曲线，去调整仿真的参数（摩擦和惯量）, 使其和真机相对应，根据调整的这些参数再去重新设置训练的参数。
- **减速器内外环不对齐**：当发生较大冲击后，减速器的内外环编码器读数发生偏移。大冲击力会对减速器内部的齿轮组或轴产生扭转，使得原本对齐的内外环产生相对位移。
	- 解决方法： 
	1. 通过软件设置检测到冲击后，自动重新对齐内外环编码器。
	2. 使用双编码器（分别测量内环和外环的位置）来检测误差，并通过算法进行误差补偿。

**机器测试流程**：
- 失能状态：摆动各个关节方向，看是否各个关节方向与期望方向相对应
- 使能状态：
	- 单关节正弦测试
	- 零位站立切换
	- 悬空 RL 测试
	- 落地 RL 测试

**机器人位控和力控方案**：